import{u as e,j as t,s as r}from"./index-DbXlpiY_.js";import{e as n,r as s}from"./vendor-DkI5JUVe.js";import{k as o,r as i}from"./kakaoPayService-Dsrou2n3.js";import"./supabase-DEy9n1le.js";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function f(e,t,r){return(f=d()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var s=new(Function.bind.apply(e,n));return r&&u(s,r.prototype),s}).apply(null,arguments)}function m(e){var t="function"==typeof Map?new Map:void 0;return m=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return f(e,arguments,l(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),u(n,e)},m(e)}function p(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function x(e){var t=d();return function(){var r,n=l(e);if(t){var s=l(this).constructor;r=Reflect.construct(n,arguments,s)}else r=n.apply(this,arguments);return p(this,r)}}var b=null;function h(e){return window[e]}var y=function(){c(t,m(Error));var e=x(t);function t(r){var n;return a(this,t),(n=e.call(this,"[TossPayments SDK] ".concat(r," is not available"))).name="NamespaceNotAvailableError",n}return t}(),g=function(){c(t,m(Error));var e=x(t);function t(r){var n;return a(this,t),(n=e.call(this,"[TossPayments SDK] Failed to load script: [".concat(r,"]"))).name="ScriptLoadFailedError",n}return t}();function v(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).src,r=void 0===t?"https://js.tosspayments.com/v1":t;return"undefined"==typeof window?Promise.resolve({requestPayment:function(){throw new Error("[TossPayments SDK] It looks like runtime is not from browser. This method is only executable on browser.")},requestBillingAuth:function(){throw new Error("[TossPayments SDK] It looks like runtime is not from browser. This method is only executable on browser.")},cancelPayment:function(){throw new Error("[TossPayments SDK] It looks like runtime is not from browser. This method is only executable on browser.")}}):function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null!=b)return b;var n=new Promise(function(n,s){try{var o=function(){null!=h(t)?n(h(t)):s(new y(t))},i=function(){s(new g(e))};if("undefined"==typeof window||"undefined"==typeof document)return n(null);if(null!=h(t))return n(h(t));var a,c=document.querySelector('script[src="'.concat(e,'"]'));null!=c&&(c.removeEventListener("load",o),c.removeEventListener("error",i),null===(a=c.parentElement)||void 0===a||a.removeChild(c));var l=document.createElement("script");l.src=e,l.addEventListener("load",o),l.addEventListener("error",i),null!=r.priority&&(l.fetchPriority=r.priority),document.head.appendChild(l)}catch(u){return void s(u)}});return b=n.catch(function(e){return b=null,Promise.reject(e)})}(r,"TossPayments").then(function(t){return t(e)})}function j(){const a=n(),{user:c}=e(),[l,u]=s.useState(null),[d,f]=s.useState(!1),[m,p]=s.useState("KAKAOPAY"),[x,b]=s.useState(!1),[h,y]=s.useState(null),[g,j]=s.useState([]),[w,N]=s.useState(0),[S,k]=s.useState(!0);s.useEffect(()=>{(async()=>{try{const{data:e,error:t}=await r.from("coin_packages").select("*").order("display_order",{ascending:!0});if(t)j([{id:"basic",coins:50,price:5e3},{id:"standard",coins:100,price:9e3,bonus:10},{id:"premium",coins:300,price:25e3,bonus:50,popular:!0},{id:"vip",coins:500,price:4e4,bonus:100},{id:"mega",coins:1e3,price:75e3,bonus:250},{id:"ultra",coins:2e3,price:14e4,bonus:600}]);else if(e&&e.length>0){const t=e.map(e=>({id:e.id.toString(),name:e.name,coins:e.coins,price:e.price,bonus_coins:e.bonus_coins,bonus:e.bonus_coins,is_popular:e.is_popular,popular:e.is_popular}));j(t)}if(c?.id){const{data:e,error:t}=await r.from("users").select("coins").eq("id",c.id).single();!t&&e&&N(e.coins||0)}}catch(e){}finally{k(!1)}})()},[c]),s.useEffect(()=>{(async()=>{try{const e=await v("test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq");y(e)}catch(e){}})()},[]);return t.jsxs("div",{className:"min-h-screen bg-white",children:[t.jsx("div",{className:"border-b border-gray-100 sticky top-0 z-30 bg-white",children:t.jsxs("div",{className:"flex items-center justify-between px-5 py-4",children:[t.jsx("button",{onClick:()=>a(-1),className:"w-10 h-10 flex items-center justify-center cursor-pointer",children:t.jsx("i",{className:"ri-arrow-left-line text-2xl text-gray-800"})}),t.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"자석 충전"}),t.jsx("div",{className:"w-10"})]})}),t.jsxs("div",{className:"px-5 py-8 text-center border-b border-gray-100",children:[t.jsx("p",{className:"text-sm text-gray-500 mb-2",children:"보유 자석"}),t.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[t.jsx("img",{src:"/image/magnet.png",alt:"자석",className:"w-8 h-8"}),t.jsx("span",{className:"text-4xl font-bold text-gray-900",children:S?"...":w.toLocaleString()})]})]}),t.jsx("div",{className:"px-5 py-6",children:t.jsx("div",{className:"space-y-3",children:g.map(e=>t.jsxs("button",{onClick:()=>(e=>{u(e),f(!0)})(e),className:"w-full flex items-center justify-between p-5 rounded-2xl border-2 transition-all cursor-pointer "+(e.popular?"border-pink-500 bg-pink-50":"border-gray-200 bg-white hover:border-gray-300"),children:[t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center "+(e.popular?"bg-pink-50":"bg-gray-100"),children:t.jsx("img",{src:"/image/magnet.png",alt:"자석",className:"w-8 h-8"})}),t.jsxs("div",{className:"text-left",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[t.jsx("span",{className:"text-2xl font-bold text-gray-900",children:e.coins.toLocaleString()}),(e.bonus||e.bonus_coins)&&t.jsxs("span",{className:"text-sm font-medium text-pink-500",children:["+",e.bonus_coins||e.bonus]})]}),(e.popular||e.is_popular)&&t.jsx("span",{className:"text-xs font-medium text-pink-500",children:"인기"})]})]}),t.jsx("div",{className:"text-right",children:t.jsxs("div",{className:"text-xl font-bold text-gray-900",children:[e.price.toLocaleString(),"원"]})})]},e.id))})}),d&&l&&t.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white w-full max-w-sm rounded-2xl overflow-hidden animate-scale-in shadow-2xl",children:[t.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-gray-100",children:[t.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"결제하기"}),t.jsx("button",{onClick:()=>f(!1),className:"w-8 h-8 flex items-center justify-center cursor-pointer rounded-full hover:bg-gray-100",children:t.jsx("i",{className:"ri-close-line text-xl text-gray-500"})})]}),t.jsxs("div",{className:"p-5",children:[t.jsxs("div",{className:"flex items-center justify-between bg-gray-50 rounded-xl p-4 mb-5",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("img",{src:"/image/magnet.png",alt:"자석",className:"w-10 h-10"}),t.jsx("div",{children:t.jsxs("div",{className:"text-xl font-bold text-gray-900",children:[l.coins.toLocaleString(),(l.bonus||l.bonus_coins)&&t.jsxs("span",{className:"text-sm text-pink-500 ml-1",children:["+",l.bonus_coins||l.bonus]})]})})]}),t.jsxs("div",{className:"text-xl font-bold text-gray-900",children:[l.price.toLocaleString(),"원"]})]}),t.jsx("button",{onClick:async()=>{if(l){if(!c?.id)return alert("로그인이 필요합니다."),void a("/login");b(!0);try{const e=l.bonus_coins||l.bonus||0,t=l.coins+e,r=`자석 ${l.coins}개${e>0?` (+${e} 보너스)`:""}`;if(localStorage.setItem("selectedPackageId",l.id),localStorage.setItem("selectedCoins",t.toString()),localStorage.setItem("selectedBonusCoins",e.toString()),localStorage.setItem("selectedPackageName",l.name||r),"KAKAOPAY"===m){const t=await o(c.id,{id:l.id,name:r,coins:l.coins,price:l.price,bonus:e});return void(t.success&&t.data?i(t.data):alert(t.error||"카카오페이 결제 요청에 실패했습니다."))}if(!h)return void alert("결제 시스템을 불러오는 중입니다. 잠시 후 다시 시도해주세요.");const n=`ORDER_${Date.now()}_${Math.random().toString(36).substring(2,11)}`;await h.requestPayment(m,{amount:l.price,orderId:n,orderName:r,successUrl:`${window.location.origin}/payment/success?orderId=${n}`,failUrl:`${window.location.origin}/payment/fail`,customerName:c.name||"사용자"})}catch(e){alert(e.message||"결제 요청에 실패했습니다. 다시 시도해주세요.")}finally{b(!1)}}},disabled:x,className:"w-full bg-yellow-400 text-black py-4 rounded-xl font-bold text-lg hover:bg-yellow-500 transition-all cursor-pointer disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center space-x-2",children:x?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"}),t.jsx("span",{children:"결제 진행 중..."})]}):t.jsx(t.Fragment,{children:t.jsx("span",{className:"font-bold",children:"카카오페이"})})}),t.jsx("p",{className:"text-xs text-gray-400 text-center mt-3",children:"결제 시 카카오페이 앱으로 이동합니다"})]})]})})]})}export{j as default};
