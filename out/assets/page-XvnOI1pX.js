import{u as e,s as t,j as s}from"./index-MGgYOwZh.js";import{d as a,r as i}from"./vendor-DxrR1XxW.js";import"./supabase-DKAQY1gD.js";const r=e=>{const t=new Date,s=new Date(e.getTime()+864e5).getTime()-t.getTime();if(s<=0)return"ë§Œë£Œë¨";const a=Math.floor(s/36e5),i=Math.floor(s%36e5/6e4);return a>0?`${a}ì‹œê°„ ${i}ë¶„ ë‚¨ìŒ`:`${i}ë¶„ ë‚¨ìŒ`},n=e=>"male"===e?"https://readdy.ai/api/search-image?query=minimalist%20male%20silhouette%20profile%20avatar%20icon%20on%20clean%20white%20background%20simple%20modern%20design%20professional%20business%20style%20neutral%20gray%20color%20scheme%20front%20facing%20head%20and%20shoulders%20portrait%20clean%20lines%20vector%20style%20illustration&width=300&height=300&seq=male-default-avatar&orientation=squarish":"https://readdy.ai/api/search-image?query=minimalist%20female%20silhouette%20profile%20avatar%20icon%20on%20clean%20white%20background%20simple%20modern%20design%20professional%20business%20style%20neutral%20gray%20color%20scheme%20front%20facing%20head%20and%20shoulders%20portrait%20clean%20lines%20vector%20style%20illustration&width=300&height=300&seq=female-default-avatar&orientation=squarish";function c(){const c=a(),{user:o}=e(),[l,d]=i.useState("received"),[m,x]=i.useState(!1),[u,h]=i.useState(null),[g,f]=i.useState([]),[p,y]=i.useState([]),[b,j]=i.useState(!0),w=50;i.useEffect(()=>{o?.id&&v()},[o?.id]);const N=async(e,s)=>{const a=new Date,i=e.filter(e=>{if("pending"!==e.status)return!1;const t=new Date(e.created_at);return(a.getTime()-t.getTime())/36e5>=24});for(const n of i)try{await t.from("matching_requests").update({status:"expired"}).eq("id",n.id);const e=n.from_user_id,{data:s}=await t.from("users").select("coins").eq("id",e).single();s&&(await t.from("users").update({coins:(s.coins||0)+w}).eq("id",e),await t.from("notifications").insert({user_id:e,type:"refund",title:"ìì„ í™˜ë¶ˆ ğŸ’",message:"ë§¤ì¹­ ìš”ì²­ì´ 24ì‹œê°„ ì´ˆê³¼ë¡œ ìë™ ë§Œë£Œë˜ì–´ ìì„ 50ê°œê°€ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤.",data:{},read:!1}))}catch(r){}return i.length>0},v=async()=>{if(o?.id){j(!0);try{const{data:e,error:s}=await t.from("matching_requests").select("id, from_user_id, status, created_at").eq("to_user_id",o.id).eq("status","pending").order("created_at",{ascending:!1}),{data:a,error:i}=await t.from("matching_requests").select("id, to_user_id, from_user_id, status, created_at").eq("from_user_id",o.id).order("created_at",{ascending:!1});if(s||i)return;let r=!1;if(e&&e.length>0){await N(e)&&(r=!0)}if(a&&a.length>0){const e=a.filter(e=>"pending"===e.status);await N(e)&&(r=!0)}if(r)return j(!1),void v();const c=e?.map(e=>e.from_user_id)||[],l=a?.map(e=>e.to_user_id)||[],d=[...new Set([...c,...l])];let m={};if(d.length>0){const{data:e,error:s}=await t.from("users").select("id, name, age, gender, location, school, mbti, bio, profile_image").in("id",d);s||e&&(m=Object.fromEntries(e.map(e=>[e.id,e])))}if(e){const t=e.filter(e=>m[e.from_user_id]).map(e=>{const t=m[e.from_user_id];return{id:e.id.toString(),userId:e.from_user_id,name:t.name||"ì‚¬ìš©ì",age:t.age||20,gender:t.gender||"unknown",location:t.location||"ìœ„ì¹˜ ë¯¸ì„¤ì •",school:t.school||"í•™êµ ë¯¸ì„¤ì •",mbti:t.mbti,bio:t.bio||"ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.",avatar:t.profile_image||n(t.gender),timestamp:new Date(e.created_at).toLocaleString("ko-KR"),createdAt:new Date(e.created_at),status:e.status}}).filter(e=>"pending"===e.status);f(t)}if(a){const e=a.filter(e=>m[e.to_user_id]).map(e=>{const t=m[e.to_user_id];return{id:e.id.toString(),userId:e.to_user_id,name:t.name||"ì‚¬ìš©ì",age:t.age||20,gender:t.gender||"unknown",location:t.location||"ìœ„ì¹˜ ë¯¸ì„¤ì •",school:t.school||"í•™êµ ë¯¸ì„¤ì •",mbti:t.mbti,bio:t.bio||"ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.",avatar:t.profile_image||n(t.gender),timestamp:new Date(e.created_at).toLocaleString("ko-KR"),createdAt:new Date(e.created_at),status:e.status}});y(e)}}catch(e){}finally{j(!1)}}},_=e=>{const t=e.avatar||n(e.gender);c("/profile-detail",{state:{profile:{id:e.userId,name:e.name,age:e.age,gender:e.gender,location:e.location,school:e.school,mbti:e.mbti,bio:e.bio,character:t,photos:t?[t]:[]}}})},q=e=>{const t=g.find(t=>t.id===e);t&&(e=>{h(e),x(!0)})(t)},k=(e,s)=>{(async(e,s)=>{if(o?.id)try{await t.from("matching_requests").update({status:"rejected"}).eq("id",e);const{data:a}=await t.from("users").select("coins").eq("id",s).single();a&&(await t.from("users").update({coins:(a.coins||0)+w}).eq("id",s),await t.from("notifications").insert({user_id:s,type:"refund",title:"ìì„ í™˜ë¶ˆ ğŸ’",message:"ë§¤ì¹­ ìš”ì²­ì´ ê±°ì ˆë˜ì–´ ìì„ 50ê°œê°€ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤.",data:{},read:!1})),v()}catch(a){alert("ìš”ì²­ ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}})(e,s)};return b?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("i",{className:"ri-loader-4-line text-4xl text-cyan-500 animate-spin mb-4"}),s.jsx("p",{className:"text-gray-500",children:"ë¡œë”© ì¤‘..."})]})}):s.jsxs("div",{className:"min-h-screen bg-gray-50 pb-20",children:[s.jsx("div",{className:"bg-white border-b sticky top-0 z-10",children:s.jsxs("div",{className:"flex items-center justify-between px-4 py-4",children:[s.jsx("button",{onClick:()=>{c(-1)},className:"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors cursor-pointer",children:s.jsx("i",{className:"ri-arrow-left-line text-xl"})}),s.jsx("h1",{className:"text-lg font-bold",children:"ë§¤ì¹­ ê´€ë¦¬"}),s.jsx("div",{className:"w-10"})]})}),s.jsxs("div",{className:"bg-white px-4 py-3 flex space-x-2 border-b",children:[s.jsxs("button",{onClick:()=>d("received"),className:"flex-1 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap cursor-pointer "+("received"===l?"bg-cyan-500 text-white":"bg-gray-100 text-gray-600"),children:["ë°›ì€ ìš”ì²­ (",g.length,")"]}),s.jsxs("button",{onClick:()=>d("sent"),className:"flex-1 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap cursor-pointer "+("sent"===l?"bg-cyan-500 text-white":"bg-gray-100 text-gray-600"),children:["ë³´ë‚¸ ìš”ì²­ (",p.length,")"]})]}),s.jsx("div",{className:"px-4 py-4",children:"received"===l?0===g.length?s.jsxs("div",{className:"text-center py-16",children:[s.jsx("div",{className:"w-20 h-20 flex items-center justify-center mx-auto mb-4 bg-gray-100 rounded-full",children:s.jsx("i",{className:"ri-mail-open-line text-4xl text-gray-300"})}),s.jsx("p",{className:"text-gray-500 font-medium",children:"ë°›ì€ ë§¤ì¹­ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤"}),s.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"í”„ë¡œí•„ì„ ì™„ì„±í•˜ê³  ì¢‹ì•„ìš”ë¥¼ ë°›ì•„ë³´ì„¸ìš”!"})]}):s.jsx("div",{className:"space-y-3",children:g.map(e=>s.jsxs("div",{className:"bg-white rounded-2xl shadow-sm p-4 hover:shadow-md transition-shadow",children:[s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsx("img",{src:e.avatar||n(e.gender),alt:e.name,loading:"lazy",decoding:"async",className:"w-16 h-16 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>_(e)}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[s.jsx("h3",{className:"font-bold text-gray-800 cursor-pointer hover:text-cyan-500",onClick:()=>_(e),children:e.name}),s.jsxs("span",{className:"text-sm text-gray-500",children:[e.age,"ì„¸"]})]}),s.jsx("p",{className:"text-sm text-gray-600 mb-1",children:e.location}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("span",{className:"text-xs text-gray-400",children:e.timestamp}),s.jsxs("span",{className:"text-xs text-orange-500 font-medium",children:[s.jsx("i",{className:"ri-time-line mr-0.5"}),r(e.createdAt)]})]})]})]}),s.jsxs("div",{className:"flex space-x-2 mt-4",children:[s.jsx("button",{onClick:()=>q(e.id),className:"flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-2 rounded-full text-sm font-medium hover:from-cyan-600 hover:to-blue-700 transition-all cursor-pointer whitespace-nowrap",children:"ìˆ˜ë½"}),s.jsx("button",{onClick:()=>k(e.id,e.userId),className:"flex-1 bg-gray-100 text-gray-600 py-2 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors cursor-pointer whitespace-nowrap",children:"ê±°ì ˆ"})]})]},e.id))}):0===p.length?s.jsxs("div",{className:"text-center py-16",children:[s.jsx("div",{className:"w-20 h-20 flex items-center justify-center mx-auto mb-4 bg-gray-100 rounded-full",children:s.jsx("i",{className:"ri-mail-send-line text-4xl text-gray-300"})}),s.jsx("p",{className:"text-gray-500 font-medium",children:"ë³´ë‚¸ ë§¤ì¹­ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤"}),s.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"ë§ˆìŒì— ë“œëŠ” ì‚¬ëŒì—ê²Œ ë§¤ì¹­ì„ ì‹ ì²­í•´ë³´ì„¸ìš”!"})]}):s.jsx("div",{className:"space-y-3",children:p.map(e=>s.jsx("div",{className:"bg-white rounded-2xl shadow-sm p-4 hover:shadow-md transition-shadow",children:s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsx("img",{src:e.avatar||n(e.gender),alt:e.name,loading:"lazy",decoding:"async",className:"w-16 h-16 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>_(e)}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[s.jsx("h3",{className:"font-bold text-gray-800 cursor-pointer hover:text-cyan-500",onClick:()=>_(e),children:e.name}),s.jsxs("span",{className:"text-sm text-gray-500",children:[e.age,"ì„¸"]})]}),s.jsx("p",{className:"text-sm text-gray-600 mb-1",children:e.location}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("span",{className:"text-xs px-2 py-1 rounded-full "+("pending"===e.status?"bg-yellow-100 text-yellow-700":"accepted"===e.status?"bg-cyan-100 text-cyan-700":"expired"===e.status?"bg-orange-100 text-orange-700":"bg-gray-100 text-gray-600"),children:"pending"===e.status?"ëŒ€ê¸°ì¤‘":"accepted"===e.status?"ìˆ˜ë½ë¨":"expired"===e.status?"ë§Œë£Œë¨ (í™˜ë¶ˆì™„ë£Œ)":"ê±°ì ˆë¨ (í™˜ë¶ˆì™„ë£Œ)"}),"pending"===e.status&&s.jsxs("span",{className:"text-xs text-orange-500 font-medium",children:[s.jsx("i",{className:"ri-time-line mr-0.5"}),r(e.createdAt)]})]})]})]})},e.id))})}),m&&u&&s.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:s.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm w-full text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4",children:s.jsx("i",{className:"ri-heart-fill text-white text-2xl"})}),s.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:"ë§¤ì¹­ ìˆ˜ë½"}),s.jsxs("p",{className:"text-gray-600 mb-2",children:[u.name,"ë‹˜ê³¼ì˜ ë§¤ì¹­ì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]}),s.jsxs("p",{className:"text-cyan-600 font-medium mb-2",children:["ìì„ ",w,"ê°œê°€ ì†Œëª¨ë©ë‹ˆë‹¤"]}),s.jsx("div",{className:"bg-cyan-50 rounded-xl p-3 mb-4",children:s.jsxs("p",{className:"text-sm text-cyan-700",children:[s.jsx("i",{className:"ri-information-line mr-1"}),"ìƒëŒ€ê°€ ê±°ì ˆí•˜ë©´ ìì„ì´ í™˜ë¶ˆë©ë‹ˆë‹¤"]})}),s.jsxs("div",{className:"flex space-x-3",children:[s.jsx("button",{onClick:()=>{x(!1),h(null)},className:"flex-1 bg-gray-100 text-gray-600 py-3 rounded-full font-medium hover:bg-gray-200 transition-all cursor-pointer whitespace-nowrap",children:"ì·¨ì†Œ"}),s.jsx("button",{onClick:async()=>{if(u&&o?.id)try{const{data:e}=await t.from("users").select("coins").eq("id",o.id).single(),s=e?.coins||0;if(s<w)return alert(`ìì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ${s}ê°œ ë³´ìœ  ì¤‘ (í•„ìš”: 50ê°œ)`),x(!1),void c("/coin-shop");await t.from("users").update({coins:s-w}).eq("id",o.id),await t.from("matching_requests").update({status:"accepted"}).eq("id",u.id);const a=new CustomEvent("openChat",{detail:{userId:u.userId,userName:u.name,userAvatar:u.avatar}});window.dispatchEvent(a),x(!1),h(null),v(),setTimeout(()=>{c("/")},500)}catch(e){alert("ìš”ì²­ ìˆ˜ë½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},className:"flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-3 rounded-full font-medium hover:from-cyan-600 hover:to-blue-700 transition-all cursor-pointer whitespace-nowrap",children:"ìˆ˜ë½"})]})]})})]})}export{c as default};
