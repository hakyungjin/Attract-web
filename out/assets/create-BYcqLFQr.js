import{s as e,u as t,j as a}from"./index-MGgYOwZh.js";import{d as r,r as s}from"./vendor-DxrR1XxW.js";import"./supabase-DKAQY1gD.js";function l(){const l=r(),{user:n}=t(),[i,o]=s.useState(""),[c,d]=s.useState("dating"),[m,u]=s.useState([]),[g,h]=s.useState([]),[x,b]=s.useState(!1),[p,f]=s.useState(!1),y=async t=>{if(t.preventDefault(),!i.trim())return void alert("내용을 입력해주세요.");const a=(()=>{if(n)return n;const e=localStorage.getItem("user");return e?JSON.parse(e):null})();if(!a)return alert("로그인이 필요합니다."),void l("/login");f(!0);try{const{data:t,error:r}=await e.from("community_posts").insert({user_id:a.id,author_name:a.name||"익명",avatar_url:a.avatar_url||"",title:i.substring(0,50),content:i.trim(),image_url:m.length>0?m[0]:null,likes:0,views:0,category:c,age:a.age,location:a.location,job:a.school||a.job}).select().single();if(r)throw r;alert("게시물이 작성되었습니다!"),l("/")}catch(r){alert(`게시물 작성에 실패했습니다: ${r.message}`)}finally{f(!1)}};return a.jsxs("div",{className:"min-h-screen bg-white",children:[a.jsx("div",{className:"border-b border-gray-100 sticky top-0 z-30 bg-white",children:a.jsxs("div",{className:"flex items-center justify-between px-5 py-4",children:[a.jsx("button",{onClick:()=>l(-1),className:"text-gray-600 hover:text-gray-900",children:a.jsx("i",{className:"ri-close-line text-2xl"})}),a.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"새 게시물"}),a.jsx("button",{onClick:y,disabled:p||!i.trim(),className:"text-pink-500 font-bold disabled:opacity-50 disabled:cursor-not-allowed",children:p?"게시 중...":"게시"})]})}),a.jsxs("form",{onSubmit:y,className:"p-5",children:[a.jsxs("div",{className:"flex gap-2 mb-4",children:[a.jsx("button",{type:"button",onClick:()=>d("dating"),className:"flex-1 py-2 px-4 rounded-lg font-medium transition-colors "+("dating"===c?"bg-pink-500 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"소개팅"}),a.jsx("button",{type:"button",onClick:()=>d("chat"),className:"flex-1 py-2 px-4 rounded-lg font-medium transition-colors "+("chat"===c?"bg-cyan-500 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"잡담"})]}),a.jsx("textarea",{value:i,onChange:e=>o(e.target.value),placeholder:"무슨 생각을 하고 계신가요?",className:"w-full min-h-[200px] text-lg border-none outline-none resize-none",autoFocus:!0}),g.length>0&&a.jsx("div",{className:"grid grid-cols-2 gap-2 mt-4",children:g.map((e,t)=>a.jsxs("div",{className:"relative aspect-square",children:[a.jsx("img",{src:e,alt:`미리보기 ${t+1}`,className:"w-full h-full object-cover rounded-lg"}),a.jsx("button",{type:"button",onClick:()=>(e=>{u(t=>t.filter((t,a)=>a!==e)),h(t=>t.filter((t,a)=>a!==e))})(t),className:"absolute top-2 right-2 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70",children:a.jsx("i",{className:"ri-close-line text-lg"})})]},t))}),a.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-5",children:a.jsxs("label",{className:"flex items-center justify-center w-full py-4 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-pink-500 hover:bg-pink-50 transition-all "+(x?"opacity-50 cursor-not-allowed":""),children:[a.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:async t=>{const a=Array.from(t.target.files||[]);if(0!==a.length)if(m.length+a.length>5)alert("이미지는 최대 5개까지 업로드할 수 있습니다.");else{b(!0);try{const t=a.map(async t=>{const a=URL.createObjectURL(t);h(e=>[...e,a]);const r=await(async(t,a="avatars",r)=>{try{const s=t.name.split(".").pop(),l=`${Date.now()}_${Math.random().toString(36).substring(2,9)}.${s}`,n=r?`${r}/${l}`:l,{data:i,error:o}=await e.storage.from(a).upload(n,t,{cacheControl:"3600",upsert:!1});if(o)throw new Error(`이미지 업로드 실패: ${o.message}`);const{data:{publicUrl:c}}=e.storage.from(a).getPublicUrl(n);return c}catch(s){throw s}})(t,"posts","community");return r}),r=await Promise.all(t);u(e=>[...e,...r])}catch(r){alert("이미지 업로드에 실패했습니다.")}finally{b(!1)}}},className:"hidden",disabled:x||m.length>=5}),x?a.jsxs("span",{className:"text-gray-600",children:[a.jsx("i",{className:"ri-loader-4-line animate-spin mr-2"}),"업로드 중..."]}):a.jsxs("span",{className:"text-gray-600",children:[a.jsx("i",{className:"ri-image-add-line text-xl mr-2"}),"사진 추가 (",m.length,"/5)"]})]})})]})]})}export{l as default};
