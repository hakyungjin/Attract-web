import{u as e,s as t,l as s,j as a}from"./index-C_8blxm2.js";import{e as r,r as i}from"./vendor-DkI5JUVe.js";import{g as n}from"./avatarUtils-Jlyh85v5.js";import"./supabase-DEy9n1le.js";const c=e=>{const t=new Date,s=new Date(e.getTime()+864e5).getTime()-t.getTime();if(s<=0)return"ë§Œë£Œë¨";const a=Math.floor(s/36e5),r=Math.floor(s%36e5/6e4);return a>0?`${a}ì‹œê°„ ${r}ë¶„ ë‚¨ìŒ`:`${r}ë¶„ ë‚¨ìŒ`};function o(){const o=r(),{user:l}=e(),[d,m]=i.useState("received"),[x,u]=i.useState(!1),[g,f]=i.useState(null),[h,p]=i.useState([]),[y,j]=i.useState([]),[b,w]=i.useState(!0),N=50;i.useEffect(()=>{l?.id&&_()},[l?.id]);const v=async(e,a)=>{const r=new Date,i=e.filter(e=>{if("pending"!==e.status)return!1;const t=new Date(e.created_at);return(r.getTime()-t.getTime())/36e5>=24});for(const c of i)try{await t.from("matching_requests").update({status:"expired"}).eq("id",c.id);const e=c.from_user_id,{data:a}=await t.from("users").select("coins").eq("id",e).single();a&&(await t.from("users").update({coins:(a.coins||0)+N}).eq("id",e),await t.from("notifications").insert({user_id:e,type:"refund",title:"ìì„ í™˜ë¶ˆ ğŸ’",message:"ë§¤ì¹­ ìš”ì²­ì´ 24ì‹œê°„ ì´ˆê³¼ë¡œ ìë™ ë§Œë£Œë˜ì–´ ìì„ 50ê°œê°€ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤.",data:{},read:!1})),s.info(`ë§Œë£Œëœ ìš”ì²­ ì²˜ë¦¬ ì™„ë£Œ: ${c.id}`)}catch(n){s.error("ë§Œë£Œ ìš”ì²­ ì²˜ë¦¬ ì‹¤íŒ¨",n)}return i.length>0},_=async()=>{if(l?.id){w(!0);try{const e=String(l.id),{data:a,error:r}=await t.from("matching_requests").select("id, from_user_id, status, created_at").eq("to_user_id",e).eq("status","pending").order("created_at",{ascending:!1}),{data:i,error:c}=await t.from("matching_requests").select("id, to_user_id, from_user_id, status, created_at").eq("from_user_id",e).order("created_at",{ascending:!1});if(r||c)return void s.error("ë§¤ì¹­ ìš”ì²­ ì¡°íšŒ ì‹¤íŒ¨",r||c);let o=!1;if(a&&a.length>0){await v(a)&&(o=!0)}if(i&&i.length>0){const e=i.filter(e=>"pending"===e.status);await v(e)&&(o=!0)}if(o)return w(!1),void _();const d=a?.map(e=>e.from_user_id)||[],m=i?.map(e=>e.to_user_id)||[],x=[...new Set([...d,...m])];let u={};if(x.length>0){const{data:e,error:a}=await t.from("users").select("id, name, age, gender, location, school, mbti, bio, profile_image").in("id",x);a?s.error("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨",a):e&&(u=Object.fromEntries(e.map(e=>[e.id,e])))}if(a){const e=a.filter(e=>u[e.from_user_id]).map(e=>{const t=u[e.from_user_id];return{id:e.id.toString(),userId:e.from_user_id,name:t.name||"ì‚¬ìš©ì",age:t.age||20,gender:t.gender||"unknown",location:t.location||"ìœ„ì¹˜ ë¯¸ì„¤ì •",school:t.school||"í•™êµ ë¯¸ì„¤ì •",mbti:t.mbti,bio:t.bio||"ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.",avatar:t.profile_image||n(t.gender),timestamp:new Date(e.created_at).toLocaleString("ko-KR"),createdAt:new Date(e.created_at),status:e.status}}).filter(e=>"pending"===e.status);p(e)}if(i){const e=i.filter(e=>u[e.to_user_id]).map(e=>{const t=u[e.to_user_id];return{id:e.id.toString(),userId:e.to_user_id,name:t.name||"ì‚¬ìš©ì",age:t.age||20,gender:t.gender||"unknown",location:t.location||"ìœ„ì¹˜ ë¯¸ì„¤ì •",school:t.school||"í•™êµ ë¯¸ì„¤ì •",mbti:t.mbti,bio:t.bio||"ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.",avatar:t.profile_image||n(t.gender),timestamp:new Date(e.created_at).toLocaleString("ko-KR"),createdAt:new Date(e.created_at),status:e.status}});j(e)}}catch(e){s.error("ë§¤ì¹­ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨",e)}finally{w(!1)}}},q=e=>{const t=e.avatar||n(e.gender);o("/profile-detail",{state:{profile:{id:e.userId,name:e.name,age:e.age,gender:e.gender,location:e.location,school:e.school,mbti:e.mbti,bio:e.bio,character:t,photos:t?[t]:[]}}})},k=e=>{const t=h.find(t=>t.id===e);t&&(e=>{f(e),u(!0)})(t)},S=(e,a)=>{(async(e,a)=>{if(l?.id)try{await t.from("matching_requests").update({status:"rejected"}).eq("id",e);const{data:s}=await t.from("users").select("coins").eq("id",a).single();s&&(await t.from("users").update({coins:(s.coins||0)+N}).eq("id",a),await t.from("notifications").insert({user_id:a,type:"refund",title:"ìì„ í™˜ë¶ˆ ğŸ’",message:"ë§¤ì¹­ ìš”ì²­ì´ ê±°ì ˆë˜ì–´ ìì„ 50ê°œê°€ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤.",data:{},read:!1})),_()}catch(r){s.error("ìš”ì²­ ê±°ì ˆ ì‹¤íŒ¨",r),alert("ìš”ì²­ ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}})(e,a)};return b?a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("i",{className:"ri-loader-4-line text-4xl text-cyan-500 animate-spin mb-4"}),a.jsx("p",{className:"text-gray-500",children:"ë¡œë”© ì¤‘..."})]})}):a.jsxs("div",{className:"min-h-screen bg-gray-50 pb-20",children:[a.jsx("div",{className:"bg-white border-b sticky top-0 z-10",children:a.jsxs("div",{className:"flex items-center justify-between px-4 py-4",children:[a.jsx("button",{onClick:()=>{o(-1)},className:"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors cursor-pointer",children:a.jsx("i",{className:"ri-arrow-left-line text-xl"})}),a.jsx("h1",{className:"text-lg font-bold",children:"ë§¤ì¹­ ê´€ë¦¬"}),a.jsx("div",{className:"w-10"})]})}),a.jsxs("div",{className:"bg-white px-4 py-3 flex space-x-2 border-b",children:[a.jsxs("button",{onClick:()=>m("received"),className:"flex-1 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap cursor-pointer "+("received"===d?"bg-cyan-500 text-white":"bg-gray-100 text-gray-600"),children:["ë°›ì€ ìš”ì²­ (",h.length,")"]}),a.jsxs("button",{onClick:()=>m("sent"),className:"flex-1 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap cursor-pointer "+("sent"===d?"bg-cyan-500 text-white":"bg-gray-100 text-gray-600"),children:["ë³´ë‚¸ ìš”ì²­ (",y.length,")"]})]}),a.jsx("div",{className:"px-4 py-4",children:"received"===d?0===h.length?a.jsxs("div",{className:"text-center py-16",children:[a.jsx("div",{className:"w-20 h-20 flex items-center justify-center mx-auto mb-4 bg-gray-100 rounded-full",children:a.jsx("i",{className:"ri-mail-open-line text-4xl text-gray-300"})}),a.jsx("p",{className:"text-gray-500 font-medium",children:"ë°›ì€ ë§¤ì¹­ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤"}),a.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"í”„ë¡œí•„ì„ ì™„ì„±í•˜ê³  ì¢‹ì•„ìš”ë¥¼ ë°›ì•„ë³´ì„¸ìš”!"})]}):a.jsx("div",{className:"space-y-3",children:h.map(e=>a.jsxs("div",{className:"bg-white rounded-2xl shadow-sm p-4 hover:shadow-md transition-shadow",children:[a.jsxs("div",{className:"flex items-center space-x-4",children:[a.jsx("img",{src:e.avatar||n(e.gender),alt:e.name,loading:"lazy",decoding:"async",className:"w-16 h-16 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>q(e)}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[a.jsx("h3",{className:"font-bold text-gray-800 cursor-pointer hover:text-cyan-500",onClick:()=>q(e),children:e.name}),a.jsxs("span",{className:"text-sm text-gray-500",children:[e.age,"ì„¸"]})]}),a.jsx("p",{className:"text-sm text-gray-600 mb-1",children:e.location}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("span",{className:"text-xs text-gray-400",children:e.timestamp}),a.jsxs("span",{className:"text-xs text-orange-500 font-medium",children:[a.jsx("i",{className:"ri-time-line mr-0.5"}),c(e.createdAt)]})]})]})]}),a.jsxs("div",{className:"flex space-x-2 mt-4",children:[a.jsx("button",{onClick:()=>k(e.id),className:"flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-2 rounded-full text-sm font-medium hover:from-cyan-600 hover:to-blue-700 transition-all cursor-pointer whitespace-nowrap",children:"ìˆ˜ë½"}),a.jsx("button",{onClick:()=>S(e.id,e.userId),className:"flex-1 bg-gray-100 text-gray-600 py-2 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors cursor-pointer whitespace-nowrap",children:"ê±°ì ˆ"})]})]},e.id))}):0===y.length?a.jsxs("div",{className:"text-center py-16",children:[a.jsx("div",{className:"w-20 h-20 flex items-center justify-center mx-auto mb-4 bg-gray-100 rounded-full",children:a.jsx("i",{className:"ri-mail-send-line text-4xl text-gray-300"})}),a.jsx("p",{className:"text-gray-500 font-medium",children:"ë³´ë‚¸ ë§¤ì¹­ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤"}),a.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"ë§ˆìŒì— ë“œëŠ” ì‚¬ëŒì—ê²Œ ë§¤ì¹­ì„ ì‹ ì²­í•´ë³´ì„¸ìš”!"})]}):a.jsx("div",{className:"space-y-3",children:y.map(e=>a.jsx("div",{className:"bg-white rounded-2xl shadow-sm p-4 hover:shadow-md transition-shadow",children:a.jsxs("div",{className:"flex items-center space-x-4",children:[a.jsx("img",{src:e.avatar||n(e.gender),alt:e.name,loading:"lazy",decoding:"async",className:"w-16 h-16 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>q(e)}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[a.jsx("h3",{className:"font-bold text-gray-800 cursor-pointer hover:text-cyan-500",onClick:()=>q(e),children:e.name}),a.jsxs("span",{className:"text-sm text-gray-500",children:[e.age,"ì„¸"]})]}),a.jsx("p",{className:"text-sm text-gray-600 mb-1",children:e.location}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("span",{className:"text-xs px-2 py-1 rounded-full "+("pending"===e.status?"bg-yellow-100 text-yellow-700":"accepted"===e.status?"bg-cyan-100 text-cyan-700":"expired"===e.status?"bg-orange-100 text-orange-700":"bg-gray-100 text-gray-600"),children:"pending"===e.status?"ëŒ€ê¸°ì¤‘":"accepted"===e.status?"ìˆ˜ë½ë¨":"expired"===e.status?"ë§Œë£Œë¨ (í™˜ë¶ˆì™„ë£Œ)":"ê±°ì ˆë¨ (í™˜ë¶ˆì™„ë£Œ)"}),"pending"===e.status&&a.jsxs("span",{className:"text-xs text-orange-500 font-medium",children:[a.jsx("i",{className:"ri-time-line mr-0.5"}),c(e.createdAt)]})]})]})]})},e.id))})}),x&&g&&a.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm w-full text-center",children:[a.jsx("div",{className:"w-16 h-16 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4",children:a.jsx("i",{className:"ri-heart-fill text-white text-2xl"})}),a.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:"ë§¤ì¹­ ìˆ˜ë½"}),a.jsxs("p",{className:"text-gray-600 mb-2",children:[g.name,"ë‹˜ê³¼ì˜ ë§¤ì¹­ì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]}),a.jsxs("p",{className:"text-cyan-600 font-medium mb-2",children:["ìì„ ",N,"ê°œê°€ ì†Œëª¨ë©ë‹ˆë‹¤"]}),a.jsx("div",{className:"bg-cyan-50 rounded-xl p-3 mb-4",children:a.jsxs("p",{className:"text-sm text-cyan-700",children:[a.jsx("i",{className:"ri-information-line mr-1"}),"ìƒëŒ€ê°€ ê±°ì ˆí•˜ë©´ ìì„ì´ í™˜ë¶ˆë©ë‹ˆë‹¤"]})}),a.jsxs("div",{className:"flex space-x-3",children:[a.jsx("button",{onClick:()=>{u(!1),f(null)},className:"flex-1 bg-gray-100 text-gray-600 py-3 rounded-full font-medium hover:bg-gray-200 transition-all cursor-pointer whitespace-nowrap",children:"ì·¨ì†Œ"}),a.jsx("button",{onClick:async()=>{if(g&&l?.id)try{const e=String(l.id),a=String(g.userId),{data:r}=await t.from("users").select("coins").eq("id",e).single(),i=r?.coins||0;if(i<N)return alert(`ìì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ${i}ê°œ ë³´ìœ  ì¤‘ (í•„ìš”: 50ê°œ)`),u(!1),void o("/coin-shop");await t.from("users").update({coins:i-N}).eq("id",e),await t.from("matching_requests").update({status:"accepted"}).eq("id",g.id),await t.from("matching_requests").update({status:"accepted"}).eq("from_user_id",a).eq("to_user_id",e).eq("status","pending");const{data:n}=await t.from("chat_rooms").select("id").or(`and(user1_id.eq.${e},user2_id.eq.${a}),and(user1_id.eq.${a},user2_id.eq.${e})`).single();if(!n){const{data:r,error:i}=await t.from("chat_rooms").insert({user1_id:e,user2_id:a,created_at:(new Date).toISOString()}).select().single();i?s.error("ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨",i):s.info("ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ",{chatRoom:r})}const c=new CustomEvent("openChat",{detail:{userId:g.userId,userName:g.name,userAvatar:g.avatar}});window.dispatchEvent(c),u(!1),f(null),_(),setTimeout(()=>{o("/")},500)}catch(e){s.error("ìš”ì²­ ìˆ˜ë½ ì‹¤íŒ¨",e),alert("ìš”ì²­ ìˆ˜ë½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},className:"flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-3 rounded-full font-medium hover:from-cyan-600 hover:to-blue-700 transition-all cursor-pointer whitespace-nowrap",children:"ìˆ˜ë½"})]})]})})]})}export{o as default};
