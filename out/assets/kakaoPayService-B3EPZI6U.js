import{s as e}from"./index-DMrnIJCM.js";const a="https://open-api.kakaopay.com/online/v1/payment",t=async(t,r)=>{const o=`ORDER_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s=window.location.origin,i={cid:"TC0ONETIME",partner_order_id:o,partner_user_id:t,item_name:`${r.name} (${r.coins}코인)`,quantity:1,total_amount:r.price,tax_free_amount:0,approval_url:`${s}/payment/success?orderId=${o}&packageId=${r.id}`,cancel_url:`${s}/payment/fail?reason=cancel`,fail_url:`${s}/payment/fail?reason=fail`};try{const s=await fetch(`${a}/ready`,{method:"POST",headers:{Authorization:"SECRET_KEY PRD06E3CE056EE301DAE0D4E482CB3B4F5017DE3","Content-Type":"application/json"},body:JSON.stringify(i)}),n=await s.json();return s.ok?(await e.from("payments").insert({user_id:t,order_id:o,tid:n.tid,amount:r.price,coins:r.coins+(r.bonus||0),payment_method:"KAKAOPAY",status:"pending"}),sessionStorage.setItem("kakao_pay_tid",n.tid),sessionStorage.setItem("kakao_pay_order_id",o),sessionStorage.setItem("kakao_pay_user_id",t),{success:!0,data:n}):{success:!1,error:n.msg||"결제 준비에 실패했습니다."}}catch(n){return{success:!1,error:n.message||"결제 요청 중 오류가 발생했습니다."}}},r=async t=>{const r=sessionStorage.getItem("kakao_pay_tid"),o=sessionStorage.getItem("kakao_pay_order_id"),s=sessionStorage.getItem("kakao_pay_user_id");if(!r||!o||!s)return{success:!1,error:"결제 정보를 찾을 수 없습니다."};const i={cid:"TC0ONETIME",tid:r,partner_order_id:o,partner_user_id:s,pg_token:t};try{const t=await fetch(`${a}/approve`,{method:"POST",headers:{Authorization:"SECRET_KEY PRD06E3CE056EE301DAE0D4E482CB3B4F5017DE3","Content-Type":"application/json"},body:JSON.stringify(i)}),r=await t.json();if(!t.ok)return await e.from("payments").update({status:"failed"}).eq("order_id",o),{success:!1,error:r.msg||"결제 승인에 실패했습니다."};const{data:n}=await e.from("payments").update({status:"completed",payment_key:r.aid,approved_at:r.approved_at}).eq("order_id",o).select().single();return n&&await e.rpc("add_coins",{user_id:s,amount:n.coins}),sessionStorage.removeItem("kakao_pay_tid"),sessionStorage.removeItem("kakao_pay_order_id"),sessionStorage.removeItem("kakao_pay_user_id"),{success:!0,data:r}}catch(n){return{success:!1,error:n.message||"결제 승인 중 오류가 발생했습니다."}}},o=e=>{const a=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);window.location.href=a?e.next_redirect_mobile_url:e.next_redirect_pc_url};export{r as a,t as k,o as r};
