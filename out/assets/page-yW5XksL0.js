import{u as e,f as t,l as s,j as a}from"./index-BAJ1soMH.js";import{u as r,r as i}from"./vendor-Dma7sgzX.js";import{a as n}from"./ssodaaSmsService-CW7nt422.js";import{g as c}from"./avatarUtils-Jlyh85v5.js";const o=e=>{const t=new Date,s=new Date(e.getTime()+864e5).getTime()-t.getTime();if(s<=0)return"ë§Œë£Œë¨";const a=Math.floor(s/36e5),r=Math.floor(s%36e5/6e4);return a>0?`${a}ì‹œê°„ ${r}ë¶„ ë‚¨ìŒ`:`${r}ë¶„ ë‚¨ìŒ`};function l(){const l=r(),{user:d}=e(),[m,x]=i.useState("received"),[u,h]=i.useState(!1),[g,p]=i.useState(null),[f,y]=i.useState([]),[j,b]=i.useState([]),[w,N]=i.useState(!0),v=50;i.useEffect(()=>{d?.id&&S()},[d?.id]);const _=async(e,s)=>{const a=new Date,r=e.filter(e=>{if("pending"!==e.status)return!1;const t=new Date(e.created_at);return(a.getTime()-t.getTime())/36e5>=24});for(const n of r)try{await t.matching.updateMatchingRequestStatus(n.id,"expired");const e=n.from_user_id;await t.users.incrementCoins(e,v),await t.notifications.createNotification(e,{type:"refund",title:"ìì„ í™˜ë¶ˆ ğŸ’",message:"ë§¤ì¹­ ìš”ì²­ì´ 24ì‹œê°„ ì´ˆê³¼ë¡œ ìë™ ë§Œë£Œë˜ì–´ ìì„ 50ê°œê°€ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤.",data:{}})}catch(i){}return r.length>0},S=async()=>{if(d?.id){N(!0);try{const e=String(d.id),{requests:a,error:r}=await t.matching.getReceivedRequests(e,"pending"),{requests:i,error:n}=await t.matching.getSentRequests(e);if(r||n)return void s.error("ë§¤ì¹­ ìš”ì²­ ì¡°íšŒ ì‹¤íŒ¨",r||n);let o=!1;if(a&&a.length>0){await _(a)&&(o=!0)}if(i&&i.length>0){const e=i.filter(e=>"pending"===e.status);await _(e)&&(o=!0)}if(o)return N(!1),void S();const l=a?.map(e=>e.from_user_id)||[],m=i?.map(e=>e.to_user_id)||[],x=[...new Set([...l,...m])];let u={};if(x.length>0&&await Promise.all(x.map(async e=>{const{user:s,error:a}=await t.users.getUserById(e);!a&&s&&(u[e]=s)})),a){const e=a.filter(e=>u[e.from_user_id]).map(e=>{const t=u[e.from_user_id];return{id:e.id.toString(),userId:e.from_user_id,name:t.name||"ì‚¬ìš©ì",age:t.age||20,gender:t.gender||"unknown",location:t.location||"ìœ„ì¹˜ ë¯¸ì„¤ì •",school:t.school||"í•™êµ ë¯¸ì„¤ì •",mbti:t.mbti,bio:t.bio||"ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.",avatar:t.profile_image||c(t.gender),timestamp:new Date(e.created_at).toLocaleString("ko-KR"),createdAt:new Date(e.created_at),status:e.status}}).filter(e=>"pending"===e.status);y(e)}if(i){const e=i.filter(e=>u[e.to_user_id]).map(e=>{const t=u[e.to_user_id];return{id:e.id.toString(),userId:e.to_user_id,name:t.name||"ì‚¬ìš©ì",age:t.age||20,gender:t.gender||"unknown",location:t.location||"ìœ„ì¹˜ ë¯¸ì„¤ì •",school:t.school||"í•™êµ ë¯¸ì„¤ì •",mbti:t.mbti,bio:t.bio||"ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.",avatar:t.profile_image||c(t.gender),timestamp:new Date(e.created_at).toLocaleString("ko-KR"),createdAt:new Date(e.created_at),status:e.status}});b(e)}}catch(e){s.error("ë§¤ì¹­ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨",e)}finally{N(!1)}}},C=e=>{const t=e.avatar||c(e.gender);l("/profile-detail",{state:{profile:{id:e.userId,name:e.name,age:e.age,gender:e.gender,location:e.location,school:e.school,mbti:e.mbti,bio:e.bio,character:t,photos:t?[t]:[]}}})},k=e=>{const t=f.find(t=>t.id===e);t&&(e=>{p(e),h(!0)})(t)},R=(e,a)=>{(async(e,a)=>{if(d?.id)try{await t.matching.updateMatchingRequestStatus(e,"rejected");const{user:s}=await t.users.getUserById(a);s&&(await t.users.incrementCoins(a,v),await t.notifications.createNotification(a,{type:"refund",title:"ìì„ í™˜ë¶ˆ ğŸ’",message:"ë§¤ì¹­ ìš”ì²­ì´ ê±°ì ˆë˜ì–´ ìì„ 50ê°œê°€ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤.",data:{}})),S()}catch(r){s.error("ìš”ì²­ ê±°ì ˆ ì‹¤íŒ¨",r),alert("ìš”ì²­ ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}})(e,a)};return w?a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("i",{className:"ri-loader-4-line text-4xl text-cyan-500 animate-spin mb-4"}),a.jsx("p",{className:"text-gray-500",children:"ë¡œë”© ì¤‘..."})]})}):a.jsxs("div",{className:"min-h-screen bg-gray-50 pb-20",children:[a.jsx("div",{className:"bg-white border-b sticky top-0 z-10",children:a.jsxs("div",{className:"flex items-center justify-between px-4 py-4",children:[a.jsx("button",{onClick:()=>{l(-1)},className:"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors cursor-pointer",children:a.jsx("i",{className:"ri-arrow-left-line text-xl"})}),a.jsx("h1",{className:"text-lg font-bold",children:"ë§¤ì¹­ ê´€ë¦¬"}),a.jsx("div",{className:"w-10"})]})}),a.jsxs("div",{className:"bg-white px-4 py-3 flex space-x-2 border-b",children:[a.jsxs("button",{onClick:()=>x("received"),className:"flex-1 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap cursor-pointer "+("received"===m?"bg-cyan-500 text-white":"bg-gray-100 text-gray-600"),children:["ë°›ì€ ìš”ì²­ (",f.length,")"]}),a.jsxs("button",{onClick:()=>x("sent"),className:"flex-1 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap cursor-pointer "+("sent"===m?"bg-cyan-500 text-white":"bg-gray-100 text-gray-600"),children:["ë³´ë‚¸ ìš”ì²­ (",j.length,")"]})]}),a.jsx("div",{className:"px-4 py-4",children:"received"===m?0===f.length?a.jsxs("div",{className:"text-center py-16",children:[a.jsx("div",{className:"w-20 h-20 flex items-center justify-center mx-auto mb-4 bg-gray-100 rounded-full",children:a.jsx("i",{className:"ri-mail-open-line text-4xl text-gray-300"})}),a.jsx("p",{className:"text-gray-500 font-medium",children:"ë°›ì€ ë§¤ì¹­ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤"}),a.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"í”„ë¡œí•„ì„ ì™„ì„±í•˜ê³  ì¢‹ì•„ìš”ë¥¼ ë°›ì•„ë³´ì„¸ìš”!"})]}):a.jsx("div",{className:"space-y-3",children:f.map(e=>a.jsxs("div",{className:"bg-white rounded-2xl shadow-sm p-4 hover:shadow-md transition-shadow",children:[a.jsxs("div",{className:"flex items-center space-x-4",children:[a.jsx("img",{src:e.avatar||c(e.gender),alt:e.name,loading:"lazy",decoding:"async",className:"w-16 h-16 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>C(e)}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[a.jsx("h3",{className:"font-bold text-gray-800 cursor-pointer hover:text-cyan-500",onClick:()=>C(e),children:e.name}),a.jsxs("span",{className:"text-sm text-gray-500",children:[e.age,"ì„¸"]})]}),a.jsx("p",{className:"text-sm text-gray-600 mb-1",children:e.location}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("span",{className:"text-xs text-gray-400",children:e.timestamp}),a.jsxs("span",{className:"text-xs text-orange-500 font-medium",children:[a.jsx("i",{className:"ri-time-line mr-0.5"}),o(e.createdAt)]})]})]})]}),a.jsxs("div",{className:"flex space-x-2 mt-4",children:[a.jsx("button",{onClick:()=>k(e.id),className:"flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-2 rounded-full text-sm font-medium hover:from-cyan-600 hover:to-blue-700 transition-all cursor-pointer whitespace-nowrap",children:"ìˆ˜ë½"}),a.jsx("button",{onClick:()=>R(e.id,e.userId),className:"flex-1 bg-gray-100 text-gray-600 py-2 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors cursor-pointer whitespace-nowrap",children:"ê±°ì ˆ"})]})]},e.id))}):0===j.length?a.jsxs("div",{className:"text-center py-16",children:[a.jsx("div",{className:"w-20 h-20 flex items-center justify-center mx-auto mb-4 bg-gray-100 rounded-full",children:a.jsx("i",{className:"ri-mail-send-line text-4xl text-gray-300"})}),a.jsx("p",{className:"text-gray-500 font-medium",children:"ë³´ë‚¸ ë§¤ì¹­ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤"}),a.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"ë§ˆìŒì— ë“œëŠ” ì‚¬ëŒì—ê²Œ ë§¤ì¹­ì„ ì‹ ì²­í•´ë³´ì„¸ìš”!"})]}):a.jsx("div",{className:"space-y-3",children:j.map(e=>a.jsx("div",{className:"bg-white rounded-2xl shadow-sm p-4 hover:shadow-md transition-shadow",children:a.jsxs("div",{className:"flex items-center space-x-4",children:[a.jsx("img",{src:e.avatar||c(e.gender),alt:e.name,loading:"lazy",decoding:"async",className:"w-16 h-16 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>C(e)}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[a.jsx("h3",{className:"font-bold text-gray-800 cursor-pointer hover:text-cyan-500",onClick:()=>C(e),children:e.name}),a.jsxs("span",{className:"text-sm text-gray-500",children:[e.age,"ì„¸"]})]}),a.jsx("p",{className:"text-sm text-gray-600 mb-1",children:e.location}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("span",{className:"text-xs px-2 py-1 rounded-full "+("pending"===e.status?"bg-yellow-100 text-yellow-700":"accepted"===e.status?"bg-cyan-100 text-cyan-700":"expired"===e.status?"bg-orange-100 text-orange-700":"bg-gray-100 text-gray-600"),children:"pending"===e.status?"ëŒ€ê¸°ì¤‘":"accepted"===e.status?"ìˆ˜ë½ë¨":"expired"===e.status?"ë§Œë£Œë¨ (í™˜ë¶ˆì™„ë£Œ)":"ê±°ì ˆë¨ (í™˜ë¶ˆì™„ë£Œ)"}),"pending"===e.status&&a.jsxs("span",{className:"text-xs text-orange-500 font-medium",children:[a.jsx("i",{className:"ri-time-line mr-0.5"}),o(e.createdAt)]})]})]})]})},e.id))})}),u&&g&&a.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm w-full text-center",children:[a.jsx("div",{className:"w-16 h-16 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4",children:a.jsx("i",{className:"ri-heart-fill text-white text-2xl"})}),a.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:"ë§¤ì¹­ ìˆ˜ë½"}),a.jsxs("p",{className:"text-gray-600 mb-2",children:[g.name,"ë‹˜ê³¼ì˜ ë§¤ì¹­ì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]}),a.jsxs("p",{className:"text-cyan-600 font-medium mb-2",children:["ìì„ ",v,"ê°œê°€ ì†Œëª¨ë©ë‹ˆë‹¤"]}),a.jsx("div",{className:"bg-cyan-50 rounded-xl p-3 mb-4",children:a.jsxs("p",{className:"text-sm text-cyan-700",children:[a.jsx("i",{className:"ri-information-line mr-1"}),"ìƒëŒ€ê°€ ê±°ì ˆí•˜ë©´ ìì„ì´ í™˜ë¶ˆë©ë‹ˆë‹¤"]})}),a.jsxs("div",{className:"flex space-x-3",children:[a.jsx("button",{onClick:()=>{h(!1),p(null)},className:"flex-1 bg-gray-100 text-gray-600 py-3 rounded-full font-medium hover:bg-gray-200 transition-all cursor-pointer whitespace-nowrap",children:"ì·¨ì†Œ"}),a.jsx("button",{onClick:async()=>{if(g&&d?.id)try{const a=String(d.id),r=String(g.userId),{user:i}=await t.users.getUserById(a),c=i?.coins||0;if(c<v)return alert(`ìì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ${c}ê°œ ë³´ìœ  ì¤‘ (í•„ìš”: 50ê°œ)`),h(!1),void l("/coin-shop");await t.users.decrementCoins(a,v),await t.matching.updateMatchingRequestStatus(g.id,"accepted");const{requests:o}=await t.matching.getSentRequests(r),m=o.find(e=>e.to_user_id===a&&"pending"===e.status);m&&await t.matching.updateMatchingRequestStatus(m.id,"accepted");const{chatRooms:x}=await t.chat.getUserChatRooms(a);if(!x.find(e=>e.user1_id===a&&e.user2_id===r||e.user1_id===r&&e.user2_id===a)){const{chatRoom:e,error:i}=await t.chat.createChatRoom(a,r);i?s.error("ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨",i):s.info("ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ",{chatRoom:e})}try{const{user:e}=await t.users.getUserById(r);e?.phone_number&&await n(e.phone_number,d.name||"ëˆ„êµ°ê°€")}catch(e){s.error("ë§¤ì¹­ ìˆ˜ë½ SMS ë°œì†¡ ì‹¤íŒ¨",e)}const u=new CustomEvent("openChat",{detail:{userId:g.userId,userName:g.name,userAvatar:g.avatar}});window.dispatchEvent(u),h(!1),p(null),S(),setTimeout(()=>{l("/")},500)}catch(a){s.error("ìš”ì²­ ìˆ˜ë½ ì‹¤íŒ¨",a),alert("ìš”ì²­ ìˆ˜ë½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},className:"flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-3 rounded-full font-medium hover:from-cyan-600 hover:to-blue-700 transition-all cursor-pointer whitespace-nowrap",children:"ìˆ˜ë½"})]})]})})]})}export{l as default};
