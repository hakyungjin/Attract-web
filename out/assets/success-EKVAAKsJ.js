import{u as e,j as t,s}from"./index-1T8840xh.js";import{e as a,f as r,r as n}from"./vendor-DkI5JUVe.js";import{a as o}from"./kakaoPayService-BkuIt222.js";import"./supabase-DEy9n1le.js";function l(){const l=a(),{user:c}=e(),[i]=r(),[d,m]=n.useState(!0),[x,g]=n.useState(null);return n.useEffect(()=>{(async()=>{const e=i.get("pg_token"),t=i.get("orderId"),a=i.get("paymentKey"),r=i.get("amount");if(e)try{const t=await o(e);if(!t.success||!t.data)throw new Error(t.error||"카카오페이 결제 승인에 실패했습니다.");{const e=parseInt(localStorage.getItem("selectedCoins")||"0"),a=localStorage.getItem("user");let r=0;if(a){const e=JSON.parse(a),{data:t}=await s.from("users").select("coins").eq("id",e.id).single();r=t?.coins||0}g({orderId:t.data.partner_order_id,amount:t.data.amount.total,coins:e,currentCoins:r,approvedAt:t.data.approved_at}),localStorage.removeItem("selectedPackageId"),localStorage.removeItem("selectedCoins"),localStorage.removeItem("selectedBonusCoins"),localStorage.removeItem("selectedPackageName"),m(!1)}}catch(n){alert(n.message||"결제 승인에 실패했습니다."),l(`/payment/fail?message=${encodeURIComponent(n.message)}`)}else{if(!t||!a||!r)return alert("결제 정보가 올바르지 않습니다."),void l("/coin-shop");if(!c?.id)return alert("로그인이 필요합니다."),void l("/login");try{const e=parseInt(localStorage.getItem("selectedCoins")||"0"),n=parseInt(localStorage.getItem("selectedBonusCoins")||"0"),o=localStorage.getItem("selectedPackageId")||"",l=localStorage.getItem("selectedPackageName")||"",{data:i}=await s.auth.getSession(),d=i?.session?.access_token,x=await fetch("https://ytffobltrwkgxiedorsd.supabase.co/functions/v1/confirm-payment",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({orderId:t,paymentKey:a,amount:parseInt(r),userId:c.id,coins:e,bonusCoins:n,packageId:o,packageName:l})}),p=await x.json();if(!x.ok||!p.success)throw new Error(p.message||"결제 승인에 실패했습니다.");g({orderId:p.data.orderId,amount:p.data.amount,coins:p.data.coins,currentCoins:p.data.currentCoins,approvedAt:p.data.approvedAt}),localStorage.removeItem("selectedPackageId"),localStorage.removeItem("selectedCoins"),localStorage.removeItem("selectedBonusCoins"),localStorage.removeItem("selectedPackageName"),m(!1)}catch(n){const e=n.message||"결제 승인에 실패했습니다.";alert(e),l(`/payment/fail?message=${encodeURIComponent(e)}`)}}})()},[i,l,c]),d?t.jsx("div",{className:"min-h-screen bg-white flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"w-16 h-16 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"결제를 처리하고 있습니다..."})]})}):t.jsxs("div",{className:"min-h-screen bg-white",children:[t.jsx("div",{className:"border-b border-gray-100 sticky top-0 z-30 bg-white",children:t.jsxs("div",{className:"flex items-center justify-between px-5 py-4",children:[t.jsx("div",{className:"w-10"}),t.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"결제 완료"}),t.jsx("div",{className:"w-10"})]})}),t.jsxs("div",{className:"flex flex-col items-center justify-center px-5 py-12",children:[t.jsx("div",{className:"w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6",children:t.jsx("i",{className:"ri-check-line text-5xl text-green-500"})}),t.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"결제가 완료되었습니다"}),t.jsx("p",{className:"text-gray-500 mb-8",children:"자석이 충전되었습니다"}),x&&t.jsxs("div",{className:"w-full max-w-md bg-gray-50 rounded-2xl p-6 mb-6",children:[t.jsxs("div",{className:"flex items-center justify-center mb-6 pb-6 border-b border-gray-200",children:[t.jsx("img",{src:"/image/magnet.png",alt:"자석",className:"w-12 h-12 mr-3"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"충전된 자석"}),t.jsxs("p",{className:"text-3xl font-bold text-pink-500",children:["+",x.coins.toLocaleString()]})]})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"text-gray-600",children:"주문번호"}),t.jsx("span",{className:"text-gray-900 font-medium text-sm",children:x.orderId})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"text-gray-600",children:"결제금액"}),t.jsxs("span",{className:"text-gray-900 font-bold text-xl",children:[x.amount.toLocaleString(),"원"]})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"text-gray-600",children:"현재 보유 자석"}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("img",{src:"/image/magnet.png",alt:"자석",className:"w-5 h-5"}),t.jsx("span",{className:"text-gray-900 font-bold text-lg",children:x.currentCoins?.toLocaleString()||0})]})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"text-gray-600",children:"결제일시"}),t.jsx("span",{className:"text-gray-900 font-medium",children:new Date(x.approvedAt).toLocaleString("ko-KR")})]})]})]}),t.jsxs("div",{className:"w-full max-w-md space-y-3",children:[t.jsx("button",{onClick:()=>l("/"),className:"w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-800 transition-all cursor-pointer",children:"홈으로 돌아가기"}),t.jsx("button",{onClick:()=>l("/coin-shop"),className:"w-full bg-white text-gray-900 py-4 rounded-xl font-bold text-lg border-2 border-gray-200 hover:bg-gray-50 transition-all cursor-pointer",children:"더 충전하기"})]})]})]})}export{l as default};
