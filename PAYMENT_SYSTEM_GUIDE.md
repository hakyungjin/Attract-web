# ğŸ’³ ê²°ì œ ì‹œìŠ¤í…œ êµ¬í˜„ ê°€ì´ë“œ

## ğŸ“‹ í˜„ì¬ ìƒíƒœ

### âœ… êµ¬í˜„ëœ ë¶€ë¶„
- Toss Payments SDK ì„¤ì¹˜ ë° ì´ˆê¸°í™”
- ì½”ì¸ìƒµ UI (íŒ¨í‚¤ì§€ ì„ íƒ, ê²°ì œ ëª¨ë‹¬)
- ê²°ì œ ì„±ê³µ/ì‹¤íŒ¨ í˜ì´ì§€
- ì‚¬ìš©ì ì½”ì¸ í•„ë“œ (users.coins)

### âŒ ë¯¸êµ¬í˜„ ë¶€ë¶„
- ê²°ì œ ìŠ¹ì¸ ë°±ì—”ë“œ API
- payments í…Œì´ë¸” (ê²°ì œ ì´ë ¥ ì €ì¥)
- ì‹¤ì œ ì‚¬ìš©ì ì •ë³´ ì—°ë™
- í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬
- ê²°ì œ ì´ë ¥ ì¡°íšŒ ê¸°ëŠ¥

---

## ğŸ—ï¸ êµ¬í˜„ ê³„íš

### 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì¶”ê°€

#### payments í…Œì´ë¸” ìƒì„±
Supabase SQL Editorì—ì„œ ì‹¤í–‰:

```sql
-- ============================================
-- Payments í…Œì´ë¸” ìƒì„±
-- ============================================

CREATE TABLE IF NOT EXISTS public.payments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  
  -- ì‚¬ìš©ì ì •ë³´
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  
  -- ê²°ì œ ì •ë³´
  order_id TEXT UNIQUE NOT NULL,
  payment_key TEXT,
  amount INTEGER NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'failed', 'cancelled', 'refunded')),
  
  -- ì½”ì¸ ì •ë³´
  coins INTEGER NOT NULL,
  bonus_coins INTEGER DEFAULT 0,
  total_coins INTEGER NOT NULL,
  
  -- íŒ¨í‚¤ì§€ ì •ë³´
  package_id TEXT,
  package_name TEXT,
  
  -- Toss Payments ì •ë³´
  toss_order_id TEXT,
  toss_payment_key TEXT,
  toss_method TEXT, -- 'CARD', 'TRANSFER', 'í† ìŠ¤í˜ì´' ë“±
  toss_approved_at TIMESTAMP WITH TIME ZONE,
  
  -- ë©”íƒ€ë°ì´í„°
  metadata JSONB DEFAULT '{}'::jsonb
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX IF NOT EXISTS idx_payments_user_id ON public.payments(user_id);
CREATE INDEX IF NOT EXISTS idx_payments_order_id ON public.payments(order_id);
CREATE INDEX IF NOT EXISTS idx_payments_status ON public.payments(status);
CREATE INDEX IF NOT EXISTS idx_payments_created_at ON public.payments(created_at DESC);

-- RLS ì •ì±… ì„¤ì •
ALTER TABLE public.payments ENABLE ROW LEVEL SECURITY;

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ê²°ì œ ë‚´ì—­ë§Œ ì¡°íšŒ ê°€ëŠ¥
DROP POLICY IF EXISTS "Users can view own payments" ON public.payments;
CREATE POLICY "Users can view own payments"
  ON public.payments FOR SELECT
  USING (auth.uid() = user_id);

-- ê²°ì œ ìƒì„±ì€ ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ê°€ëŠ¥ (ì‹¤ì œë¡œëŠ” Edge Functionì—ì„œ ì²˜ë¦¬)
DROP POLICY IF EXISTS "Authenticated users can insert payments" ON public.payments;
CREATE POLICY "Authenticated users can insert payments"
  ON public.payments FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- ê²°ì œ ì—…ë°ì´íŠ¸ëŠ” Edge Functionì—ì„œë§Œ ê°€ëŠ¥ (ì„œë¹„ìŠ¤ ì—­í• )
-- ì¼ë°˜ ì‚¬ìš©ìëŠ” ì—…ë°ì´íŠ¸ ë¶ˆê°€
```

---

## 2ë‹¨ê³„: Supabase Edge Function ìƒì„±

### ê²°ì œ ìŠ¹ì¸ API ìƒì„±

`supabase/functions/confirm-payment/index.ts` íŒŒì¼ ìƒì„±:

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const TOSS_SECRET_KEY = Deno.env.get('TOSS_SECRET_KEY') || '';

interface PaymentConfirmRequest {
  orderId: string;
  paymentKey: string;
  amount: number;
  userId: string;
  coins: number;
  bonusCoins?: number;
  packageId?: string;
  packageName?: string;
}

serve(async (req) => {
  // CORS í—¤ë” ì„¤ì •
  if (req.method === 'OPTIONS') {
    return new Response('ok', {
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
      },
    });
  }

  try {
    // ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±
    const body: PaymentConfirmRequest = await req.json();
    const { orderId, paymentKey, amount, userId, coins, bonusCoins = 0, packageId, packageName } = body;

    // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ì„œë¹„ìŠ¤ ì—­í•  í‚¤ ì‚¬ìš©)
    const supabaseUrl = Deno.env.get('SUPABASE_URL') || '';
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') || '';
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Toss Payments APIë¡œ ê²°ì œ ìŠ¹ì¸ ìš”ì²­
    const tossResponse = await fetch('https://api.tosspayments.com/v1/payments/confirm', {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${btoa(TOSS_SECRET_KEY + ':')}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        paymentKey,
        orderId,
        amount,
      }),
    });

    if (!tossResponse.ok) {
      const errorData = await tossResponse.json();
      throw new Error(errorData.message || 'ê²°ì œ ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }

    const tossData = await tossResponse.json();

    // ì´ ì½”ì¸ ê³„ì‚°
    const totalCoins = coins + bonusCoins;

    // ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ ì‹œì‘
    // 1. ê²°ì œ ê¸°ë¡ ìƒì„±
    const { data: payment, error: paymentError } = await supabase
      .from('payments')
      .insert({
        user_id: userId,
        order_id: orderId,
        payment_key: paymentKey,
        amount: amount,
        status: 'completed',
        coins: coins,
        bonus_coins: bonusCoins,
        total_coins: totalCoins,
        package_id: packageId,
        package_name: packageName,
        toss_order_id: tossData.orderId,
        toss_payment_key: tossData.paymentKey,
        toss_method: tossData.method,
        toss_approved_at: tossData.approvedAt,
        metadata: {
          toss_response: tossData,
        },
      })
      .select()
      .single();

    if (paymentError) {
      throw new Error(`ê²°ì œ ê¸°ë¡ ìƒì„± ì‹¤íŒ¨: ${paymentError.message}`);
    }

    // 2. ì‚¬ìš©ì ì½”ì¸ ì—…ë°ì´íŠ¸
    const { data: user, error: userError } = await supabase
      .from('users')
      .select('coins')
      .eq('id', userId)
      .single();

    if (userError || !user) {
      throw new Error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const newCoins = (user.coins || 0) + totalCoins;

    const { error: updateError } = await supabase
      .from('users')
      .update({ coins: newCoins })
      .eq('id', userId);

    if (updateError) {
      throw new Error(`ì½”ì¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateError.message}`);
    }

    // ì„±ê³µ ì‘ë‹µ
    return new Response(
      JSON.stringify({
        success: true,
        data: {
          orderId: payment.order_id,
          amount: payment.amount,
          coins: payment.total_coins,
          currentCoins: newCoins,
          approvedAt: payment.toss_approved_at,
        },
      }),
      {
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
        status: 200,
      }
    );
  } catch (error: any) {
    console.error('ê²°ì œ ìŠ¹ì¸ ì˜¤ë¥˜:', error);
    return new Response(
      JSON.stringify({
        success: false,
        message: error.message || 'ê²°ì œ ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      }),
      {
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
        status: 400,
      }
    );
  }
});
```

### Edge Function ë°°í¬

```bash
# Supabase CLI ì„¤ì¹˜ (ì•„ì§ ì•ˆ í–ˆë‹¤ë©´)
npm install -g supabase

# Supabase ë¡œê·¸ì¸
supabase login

# í”„ë¡œì íŠ¸ ë§í¬
supabase link --project-ref your-project-ref

# í•¨ìˆ˜ ë°°í¬
supabase functions deploy confirm-payment

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
supabase secrets set TOSS_SECRET_KEY=your_toss_secret_key
supabase secrets set SUPABASE_URL=your_supabase_url
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

---

## 3ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ê°œì„ 

### í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

`.env` íŒŒì¼ì— ì¶”ê°€:

```env
# Toss Payments
VITE_TOSS_CLIENT_KEY=test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq  # í…ŒìŠ¤íŠ¸ í‚¤
# í”„ë¡œë•ì…˜: ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ í‚¤ë¡œ ë³€ê²½

# Supabase (ì´ë¯¸ ìˆì„ ìˆ˜ ìˆìŒ)
VITE_SUPABASE_URL=https://ytffobltrwkgxiedorsd.supabase.co
VITE_SUPABASE_ANON_KEY=your_anon_key
```

### ì½”ì¸ìƒµ í˜ì´ì§€ ê°œì„ 

ì£¼ìš” ê°œì„  ì‚¬í•­:
1. í™˜ê²½ ë³€ìˆ˜ì—ì„œ Toss í‚¤ ê°€ì ¸ì˜¤ê¸°
2. ì‹¤ì œ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©
3. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì½”ì¸ íŒ¨í‚¤ì§€ ê°€ì ¸ì˜¤ê¸°
4. ì‚¬ìš©ì ë³´ìœ  ì½”ì¸ í‘œì‹œ

### ê²°ì œ ì„±ê³µ í˜ì´ì§€ ê°œì„ 

Supabase Edge Function í˜¸ì¶œë¡œ ë³€ê²½

---

## 4ë‹¨ê³„: ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„

### ê²°ì œ ì´ë ¥ ì¡°íšŒ
- ì‚¬ìš©ì ê²°ì œ ë‚´ì—­ í˜ì´ì§€
- ê²°ì œ ìƒì„¸ ì •ë³´ ì¡°íšŒ

### í™˜ë¶ˆ ì²˜ë¦¬ (ì„ íƒì‚¬í•­)
- ë¶€ë¶„ í™˜ë¶ˆ
- ì „ì²´ í™˜ë¶ˆ
- í™˜ë¶ˆ ì •ì±… ì ìš©

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **Secret Key ë³´í˜¸**
   - Toss Secret KeyëŠ” ì ˆëŒ€ í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œí•˜ì§€ ì•Šê¸°
   - Supabase Edge Functionì˜ í™˜ê²½ ë³€ìˆ˜ë¡œë§Œ ê´€ë¦¬

2. **ê²°ì œ ê²€ì¦**
   - ì„œë²„ì—ì„œ í•­ìƒ ê²°ì œ ê¸ˆì•¡ ì¬í™•ì¸
   - ì¤‘ë³µ ê²°ì œ ë°©ì§€ (orderId ì¤‘ë³µ ì²´í¬)

3. **ì‚¬ìš©ì ì¸ì¦**
   - ê²°ì œ ìŠ¹ì¸ ì‹œ ì‚¬ìš©ì ID ê²€ì¦
   - ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ê²°ì œë¥¼ ìŠ¹ì¸í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜

4. **ì—ëŸ¬ ì²˜ë¦¬**
   - ê²°ì œ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì²˜ë¦¬
   - ë¡œê·¸ ê¸°ë¡ ë° ëª¨ë‹ˆí„°ë§

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] í…ŒìŠ¤íŠ¸ ê²°ì œ ì„±ê³µ
- [ ] ê²°ì œ í›„ ì½”ì¸ ì¦ê°€ í™•ì¸
- [ ] ê²°ì œ ì´ë ¥ ì €ì¥ í™•ì¸
- [ ] ì¤‘ë³µ ê²°ì œ ë°©ì§€ í™•ì¸
- [ ] ê²°ì œ ì‹¤íŒ¨ ì²˜ë¦¬ í™•ì¸
- [ ] ì‚¬ìš©ìë³„ ê²°ì œ ì´ë ¥ ì¡°íšŒ í™•ì¸

---

## ğŸš€ í”„ë¡œë•ì…˜ ì „í™˜

1. **Toss Payments ê³„ì • ì„¤ì •**
   - ì‹¤ì œ ê³„ì • ìƒì„±
   - ì‹¤ì œ Secret Key ë°œê¸‰
   - ì›¹í›… ì„¤ì • (ì„ íƒì‚¬í•­)

2. **í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸**
   - í…ŒìŠ¤íŠ¸ í‚¤ â†’ ì‹¤ì œ í‚¤ë¡œ ë³€ê²½
   - Supabase í”„ë¡œë•ì…˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

3. **ëª¨ë‹ˆí„°ë§ ì„¤ì •**
   - ê²°ì œ ì‹¤íŒ¨ ì•Œë¦¼ ì„¤ì •
   - ê²°ì œ í†µê³„ ëŒ€ì‹œë³´ë“œ êµ¬ì„±

---

## ğŸ“ ì°¸ê³  ìë£Œ

- [Toss Payments ë¬¸ì„œ](https://docs.tosspayments.com/)
- [Supabase Edge Functions ë¬¸ì„œ](https://supabase.com/docs/guides/functions)
- [Supabase RLS ì •ì±… ê°€ì´ë“œ](https://supabase.com/docs/guides/auth/row-level-security)

