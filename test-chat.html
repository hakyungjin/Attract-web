<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì±„íŒ…ë°© ì‹œìŠ¤í…œ ë””ë²„ê¹…</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
      font-size: 13px;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5eb;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 15px;
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #e1e5eb;
      color: #333;
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }
    .btn-success {
      background: #10b981;
      color: white;
    }
    .btn-warning {
      background: #f59e0b;
      color: white;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    .status {
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 13px;
    }
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .status.warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }
    .log-container {
      background: #1a1a2e;
      border-radius: 10px;
      padding: 15px;
      max-height: 250px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
    }
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #2d2d44;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .log-time {
      color: #6b7280;
    }
    .log-type {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      margin: 0 5px;
    }
    .log-type.info { background: #3b82f6; color: white; }
    .log-type.success { background: #10b981; color: white; }
    .log-type.error { background: #ef4444; color: white; }
    .log-type.realtime { background: #8b5cf6; color: white; }
    .log-type.warning { background: #f59e0b; color: white; }
    .log-message {
      color: #e5e7eb;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    .message-list {
      background: white;
      border-radius: 10px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    .message-item {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      font-size: 13px;
    }
    .message-sent {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: 50px;
    }
    .message-received {
      background: #f3f4f6;
      color: #333;
      margin-right: 50px;
    }
    .realtime-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .realtime-indicator.connected {
      background: #d1fae5;
      color: #065f46;
    }
    .realtime-indicator.disconnected {
      background: #fee2e2;
      color: #991b1b;
    }
    .pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .pulse.green { background: #10b981; }
    .pulse.red { background: #ef4444; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .room-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      border: 2px solid #e1e5eb;
      cursor: pointer;
      transition: all 0.3s;
    }
    .room-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }
    .room-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .room-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge.active { background: #d1fae5; color: #065f46; }
    .badge.inactive { background: #fee2e2; color: #991b1b; }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      border-radius: 10px;
      background: #e1e5eb;
      color: #333;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    code {
      font-size: 11px;
      background: #e1e5eb;
      padding: 2px 6px;
      border-radius: 4px;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’¬ ì±„íŒ…ë°© ì‹œìŠ¤í…œ ë””ë²„ê¹…</h1>
    <p class="subtitle">ë§¤ì¹­ â†’ ì±„íŒ…ë°© ìƒì„± â†’ ë©”ì‹œì§€ ì „ì†¡ í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤</p>

    <!-- ì—°ê²° ìƒíƒœ -->
    <div class="section">
      <h3>ğŸ“¡ Supabase ì—°ê²°</h3>
      <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <div id="connectionStatus" class="realtime-indicator disconnected">
          <span class="pulse red"></span>
          <span>ì—°ê²° ì¤‘...</span>
        </div>
        <div id="realtimeStatus" class="realtime-indicator disconnected">
          <span class="pulse red"></span>
          <span>ì‹¤ì‹œê°„ ëŒ€ê¸°</span>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <div class="grid-2">
          <div>
            <label>Supabase URL</label>
            <input type="text" id="supabaseUrl" value="https://ytffobltrwkgxiedorsd.supabase.co" />
          </div>
          <div>
            <label>Supabase Anon Key</label>
            <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
          </div>
        </div>
        <button class="btn-primary" onclick="initSupabase()">ğŸ”Œ ì—°ê²°</button>
        <button class="btn-secondary" onclick="loadUsers()">ğŸ‘¥ ì‚¬ìš©ì ì¡°íšŒ</button>
      </div>
      <div id="userList" class="status info" style="display:none;"></div>
    </div>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tabs">
      <div class="tab active" onclick="showTab('matching')">ğŸ¯ ë§¤ì¹­ í…ŒìŠ¤íŠ¸</div>
      <div class="tab" onclick="showTab('chatroom')">ğŸ  ì±„íŒ…ë°©</div>
      <div class="tab" onclick="showTab('message')">âœ‰ï¸ ë©”ì‹œì§€</div>
    </div>

    <!-- ë§¤ì¹­ í…ŒìŠ¤íŠ¸ íƒ­ -->
    <div id="tab-matching" class="tab-content active">
      <div class="section">
        <h3>ğŸ¯ ë§¤ì¹­ ìš”ì²­ í…ŒìŠ¤íŠ¸</h3>
        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
          ë§¤ì¹­ì´ ìˆ˜ë½ë˜ë©´ ìë™ìœ¼ë¡œ ì±„íŒ…ë°©ì´ ìƒì„±ë©ë‹ˆë‹¤.
        </p>
        <div class="grid-2">
          <div>
            <label>ìš”ì²­ì ID (from_user_id)</label>
            <input type="text" id="fromUserId" placeholder="ìš”ì²­ ë³´ë‚´ëŠ” ì‚¬ëŒ ID" />
          </div>
          <div>
            <label>ìˆ˜ì‹ ì ID (to_user_id)</label>
            <input type="text" id="toUserId" placeholder="ìš”ì²­ ë°›ëŠ” ì‚¬ëŒ ID" />
          </div>
        </div>
        <button class="btn-primary" onclick="createMatchingRequest()">ğŸ’Œ ë§¤ì¹­ ìš”ì²­ ìƒì„±</button>
        <button class="btn-secondary" onclick="loadMatchingRequests()">ğŸ“‹ ìš”ì²­ ëª©ë¡ ì¡°íšŒ</button>
        <div id="matchingResult"></div>
        <div id="matchingList" style="margin-top: 15px;"></div>
      </div>

      <div class="section">
        <h3>âœ… ë§¤ì¹­ ìˆ˜ë½/ê±°ì ˆ</h3>
        <div class="grid-2">
          <div>
            <label>ë§¤ì¹­ ìš”ì²­ ID</label>
            <input type="text" id="matchingRequestId" placeholder="ë§¤ì¹­ ìš”ì²­ UUID" />
          </div>
          <div>
            <label>ìƒíƒœ ë³€ê²½</label>
            <select id="matchingStatus">
              <option value="accepted">âœ… ìˆ˜ë½ (accepted)</option>
              <option value="rejected">âŒ ê±°ì ˆ (rejected)</option>
            </select>
          </div>
        </div>
        <button class="btn-success" onclick="updateMatchingStatus()">ğŸ”„ ìƒíƒœ ë³€ê²½</button>
        <div id="matchingUpdateResult"></div>
      </div>
    </div>

    <!-- ì±„íŒ…ë°© íƒ­ -->
    <div id="tab-chatroom" class="tab-content">
      <div class="section">
        <h3>ğŸ  ì±„íŒ…ë°© ì¡°íšŒ</h3>
        <div>
          <label>ì‚¬ìš©ì ID (ë‚´ ID)</label>
          <input type="text" id="myUserId" placeholder="ë‚´ ì‚¬ìš©ì ID" />
        </div>
        <button class="btn-primary" onclick="loadChatRooms()">ğŸ” ë‚´ ì±„íŒ…ë°© ì¡°íšŒ</button>
        <button class="btn-secondary" onclick="loadAllChatRooms()">ğŸ“‹ ì „ì²´ ì±„íŒ…ë°© ì¡°íšŒ</button>
        <div id="chatRoomList" style="margin-top: 15px;"></div>
      </div>

      <div class="section">
        <h3>ğŸ”— ë‘ ì‚¬ìš©ì ê°„ ì±„íŒ…ë°© í™•ì¸</h3>
        <div class="grid-2">
          <div>
            <label>ì‚¬ìš©ì 1 ID</label>
            <input type="text" id="checkUser1" placeholder="ì²« ë²ˆì§¸ ì‚¬ìš©ì ID" />
          </div>
          <div>
            <label>ì‚¬ìš©ì 2 ID</label>
            <input type="text" id="checkUser2" placeholder="ë‘ ë²ˆì§¸ ì‚¬ìš©ì ID" />
          </div>
        </div>
        <button class="btn-secondary" onclick="checkChatRoomExists()">ğŸ” ì±„íŒ…ë°© ì¡´ì¬ í™•ì¸</button>
        <div id="chatRoomCheckResult"></div>
      </div>

      <div class="section">
        <h3>â• ì±„íŒ…ë°© ìˆ˜ë™ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)</h3>
        <div class="grid-2">
          <div>
            <label>ì‚¬ìš©ì 1 ID</label>
            <input type="text" id="createUser1" placeholder="ì²« ë²ˆì§¸ ì‚¬ìš©ì ID" />
          </div>
          <div>
            <label>ì‚¬ìš©ì 2 ID</label>
            <input type="text" id="createUser2" placeholder="ë‘ ë²ˆì§¸ ì‚¬ìš©ì ID" />
          </div>
        </div>
        <button class="btn-warning" onclick="createChatRoomManually()">ğŸ  ì±„íŒ…ë°© ìƒì„±</button>
        <div id="createRoomResult"></div>
      </div>
    </div>

    <!-- ë©”ì‹œì§€ íƒ­ -->
    <div id="tab-message" class="tab-content">
      <div class="section">
        <h3>âœ‰ï¸ ë©”ì‹œì§€ ì „ì†¡</h3>
        <div class="grid-3">
          <div>
            <label>ì±„íŒ…ë°© ID (room_id)</label>
            <input type="text" id="roomId" placeholder="ì±„íŒ…ë°© UUID" />
          </div>
          <div>
            <label>ë°œì‹ ì ID (sender_id)</label>
            <input type="text" id="senderId" placeholder="ë³´ë‚´ëŠ” ì‚¬ëŒ ID" />
          </div>
          <div>
            <label>ìˆ˜ì‹ ì ID (recipient_id)</label>
            <input type="text" id="recipientId" placeholder="ë°›ëŠ” ì‚¬ëŒ ID" />
          </div>
        </div>
        <label>ë©”ì‹œì§€ ë‚´ìš©</label>
        <textarea id="messageContent" rows="3" placeholder="ì•ˆë…•í•˜ì„¸ìš”! í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤."></textarea>
        <button class="btn-success" onclick="sendMessage()">ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡</button>
        <button class="btn-secondary" onclick="loadMessages()">ğŸ“¥ ë©”ì‹œì§€ ì¡°íšŒ</button>
        <div id="sendResult"></div>
      </div>

      <div class="section">
        <h3>ğŸ“‹ ë©”ì‹œì§€ ëª©ë¡</h3>
        <div id="messageList" class="message-list">
          <p style="color: #999; text-align: center;">ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ê³  ë©”ì‹œì§€ë¥¼ ì¡°íšŒí•˜ì„¸ìš”</p>
        </div>
      </div>
    </div>

    <!-- ì‹¤ì‹œê°„ êµ¬ë… -->
    <div class="section">
      <h3>ğŸ”´ ì‹¤ì‹œê°„ êµ¬ë…</h3>
      <button class="btn-primary" onclick="subscribeToAll()">ğŸ“¡ ì „ì²´ êµ¬ë…</button>
      <button class="btn-danger" onclick="unsubscribeAll()">ğŸ”‡ êµ¬ë… í•´ì œ</button>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="section">
      <h3>ğŸ“ ë””ë²„ê·¸ ë¡œê·¸</h3>
      <button class="btn-secondary" onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
      <div id="logContainer" class="log-container">
        <div class="log-entry">
          <span class="log-time">[ì‹œì‘]</span>
          <span class="log-type info">INFO</span>
          <span class="log-message">ì±„íŒ…ë°© ì‹œìŠ¤í…œ ë””ë²„ê¹… í˜ì´ì§€ ë¡œë“œë¨</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    let supabase = null;
    let subscriptions = [];

    // ==========================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ==========================================

    function addLog(type, message) {
      const container = document.getElementById('logContainer');
      const time = new Date().toLocaleTimeString('ko-KR');
      const typeClass = type.toLowerCase();
      
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-type ${typeClass}">${type.toUpperCase()}</span>
        <span class="log-message">${message}</span>
      `;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
      console.log(`[${type}] ${message}`);
    }

    function clearLogs() {
      document.getElementById('logContainer').innerHTML = '';
      addLog('info', 'ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // ==========================================
    // Supabase ì—°ê²°
    // ==========================================

    async function initSupabase() {
      const url = document.getElementById('supabaseUrl').value;
      const key = document.getElementById('supabaseKey').value;

      if (!url || !key) {
        addLog('error', 'Supabase URLê³¼ Anon Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'Supabase ì—°ê²° ì‹œë„ ì¤‘...');
        supabase = window.supabase.createClient(url, key);
        
        const { data, error } = await supabase.from('users').select('count').limit(1);
        if (error) throw error;

        document.getElementById('connectionStatus').className = 'realtime-indicator connected';
        document.getElementById('connectionStatus').innerHTML = `
          <span class="pulse green"></span>
          <span>ì—°ê²°ë¨ âœ“</span>
        `;
        
        addLog('success', 'Supabase ì—°ê²° ì„±ê³µ!');
      } catch (error) {
        addLog('error', `ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
        document.getElementById('connectionStatus').className = 'realtime-indicator disconnected';
        document.getElementById('connectionStatus').innerHTML = `
          <span class="pulse red"></span>
          <span>ì—°ê²° ì‹¤íŒ¨</span>
        `;
      }
    }

    // ==========================================
    // ì‚¬ìš©ì ì¡°íšŒ
    // ==========================================

    async function loadUsers() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì¤‘...');
        const { data, error } = await supabase
          .from('users')
          .select('id, name, gender, phone_number')
          .limit(15);

        if (error) throw error;

        const userList = document.getElementById('userList');
        userList.style.display = 'block';
        
        if (data.length === 0) {
          userList.innerHTML = 'ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.';
        } else {
          userList.innerHTML = '<strong>ğŸ‘¥ ì‚¬ìš©ì ëª©ë¡ (í´ë¦­í•˜ì—¬ ë³µì‚¬):</strong><br><br>' + 
            data.map(u => `
              <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 8px;">
                <strong>${u.name || 'ì´ë¦„ì—†ìŒ'}</strong> 
                <span style="color: #666;">(${u.gender || 'ë¯¸ì§€ì •'})</span>
                <br>
                <code onclick="navigator.clipboard.writeText('${u.id}'); addLog('info', 'ID ë³µì‚¬ë¨: ${u.id.substring(0,8)}...')" 
                      style="cursor: pointer;" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">${u.id}</code>
              </div>
            `).join('');
        }
        
        addLog('success', `${data.length}ëª…ì˜ ì‚¬ìš©ìë¥¼ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`);
      } catch (error) {
        addLog('error', `ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ==========================================
    // ë§¤ì¹­ ìš”ì²­
    // ==========================================

    async function createMatchingRequest() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      const fromUserId = document.getElementById('fromUserId').value;
      const toUserId = document.getElementById('toUserId').value;

      if (!fromUserId || !toUserId) {
        addLog('error', 'ìš”ì²­ì IDì™€ ìˆ˜ì‹ ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ë§¤ì¹­ ìš”ì²­ ìƒì„± ì¤‘...');
        
        const { data, error } = await supabase
          .from('matching_requests')
          .insert({
            from_user_id: fromUserId,
            to_user_id: toUserId,
            status: 'pending'
          })
          .select()
          .single();

        if (error) throw error;

        document.getElementById('matchingResult').innerHTML = `
          <div class="status success">
            âœ… ë§¤ì¹­ ìš”ì²­ ìƒì„± ì„±ê³µ!<br>
            ìš”ì²­ ID: <code>${data.id}</code><br>
            ìƒíƒœ: ${data.status}
          </div>
        `;
        
        // ë§¤ì¹­ ìš”ì²­ ID ìë™ ì…ë ¥
        document.getElementById('matchingRequestId').value = data.id;
        
        addLog('success', `ë§¤ì¹­ ìš”ì²­ ìƒì„± ì™„ë£Œ! ID: ${data.id}`);
      } catch (error) {
        document.getElementById('matchingResult').innerHTML = `
          <div class="status error">âŒ ì‹¤íŒ¨: ${error.message}</div>
        `;
        addLog('error', `ë§¤ì¹­ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    async function loadMatchingRequests() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ë§¤ì¹­ ìš”ì²­ ëª©ë¡ ì¡°íšŒ ì¤‘...');
        
        const { data, error } = await supabase
          .from('matching_requests')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        const list = document.getElementById('matchingList');
        
        if (data.length === 0) {
          list.innerHTML = '<div class="status info">ë§¤ì¹­ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
          list.innerHTML = data.map(req => `
            <div class="room-card" onclick="document.getElementById('matchingRequestId').value='${req.id}'">
              <div class="room-info">
                <div>
                  <strong>ID:</strong> <code>${req.id.substring(0, 8)}...</code><br>
                  <small>from: ${req.from_user_id.substring(0, 8)}... â†’ to: ${req.to_user_id.substring(0, 8)}...</small>
                </div>
                <span class="badge ${req.status === 'accepted' ? 'active' : req.status === 'pending' ? '' : 'inactive'}" 
                      style="${req.status === 'pending' ? 'background: #fef3c7; color: #92400e;' : ''}">
                  ${req.status}
                </span>
              </div>
            </div>
          `).join('');
        }
        
        addLog('success', `${data.length}ê°œì˜ ë§¤ì¹­ ìš”ì²­ì„ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`);
      } catch (error) {
        addLog('error', `ë§¤ì¹­ ìš”ì²­ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    async function updateMatchingStatus() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      const requestId = document.getElementById('matchingRequestId').value;
      const status = document.getElementById('matchingStatus').value;

      if (!requestId) {
        addLog('error', 'ë§¤ì¹­ ìš”ì²­ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', `ë§¤ì¹­ ìƒíƒœë¥¼ "${status}"ë¡œ ë³€ê²½ ì¤‘...`);
        
        const { data, error } = await supabase
          .from('matching_requests')
          .update({ status: status, updated_at: new Date().toISOString() })
          .eq('id', requestId)
          .select()
          .single();

        if (error) throw error;

        document.getElementById('matchingUpdateResult').innerHTML = `
          <div class="status success">
            âœ… ìƒíƒœ ë³€ê²½ ì„±ê³µ! â†’ ${status}<br>
            ${status === 'accepted' ? 'ğŸ  ì±„íŒ…ë°©ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!' : ''}
          </div>
        `;
        
        addLog('success', `ë§¤ì¹­ ìƒíƒœ ë³€ê²½ ì™„ë£Œ: ${status}`);
        
        if (status === 'accepted') {
          addLog('info', 'ì±„íŒ…ë°© íƒ­ì—ì„œ ìƒì„±ëœ ì±„íŒ…ë°©ì„ í™•ì¸í•˜ì„¸ìš”!');
        }
      } catch (error) {
        document.getElementById('matchingUpdateResult').innerHTML = `
          <div class="status error">âŒ ì‹¤íŒ¨: ${error.message}</div>
        `;
        addLog('error', `ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ==========================================
    // ì±„íŒ…ë°©
    // ==========================================

    async function loadChatRooms() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      const myUserId = document.getElementById('myUserId').value;

      if (!myUserId) {
        addLog('error', 'ë‚´ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ë‚´ ì±„íŒ…ë°© ì¡°íšŒ ì¤‘...');
        
        const { data, error } = await supabase
          .from('chat_rooms')
          .select('*')
          .or(`user1_id.eq.${myUserId},user2_id.eq.${myUserId}`)
          .order('last_message_at', { ascending: false, nullsFirst: false });

        if (error) throw error;

        displayChatRooms(data, myUserId);
        addLog('success', `${data.length}ê°œì˜ ì±„íŒ…ë°©ì„ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`);
      } catch (error) {
        addLog('error', `ì±„íŒ…ë°© ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    async function loadAllChatRooms() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ì „ì²´ ì±„íŒ…ë°© ì¡°íšŒ ì¤‘...');
        
        const { data, error } = await supabase
          .from('chat_rooms')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(20);

        if (error) throw error;

        displayChatRooms(data, null);
        addLog('success', `${data.length}ê°œì˜ ì±„íŒ…ë°©ì„ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`);
      } catch (error) {
        addLog('error', `ì±„íŒ…ë°© ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    function displayChatRooms(rooms, myUserId) {
      const list = document.getElementById('chatRoomList');
      
      if (rooms.length === 0) {
        list.innerHTML = '<div class="status warning">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      list.innerHTML = rooms.map(room => {
        const partnerId = myUserId 
          ? (room.user1_id === myUserId ? room.user2_id : room.user1_id)
          : null;
        
        return `
          <div class="room-card" onclick="selectChatRoom('${room.id}', '${room.user1_id}', '${room.user2_id}')">
            <div class="room-info">
              <div>
                <strong>Room:</strong> <code>${room.id.substring(0, 8)}...</code><br>
                <small>
                  User1: ${room.user1_id.substring(0, 8)}...<br>
                  User2: ${room.user2_id.substring(0, 8)}...
                </small>
                ${room.last_message ? `<br><em style="color: #666;">"${room.last_message.substring(0, 30)}..."</em>` : ''}
              </div>
              <span class="badge ${room.is_active !== false ? 'active' : 'inactive'}">
                ${room.is_active !== false ? 'Active' : 'Inactive'}
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    function selectChatRoom(roomId, user1Id, user2Id) {
      document.getElementById('roomId').value = roomId;
      document.getElementById('senderId').value = user1Id;
      document.getElementById('recipientId').value = user2Id;
      
      // ë©”ì‹œì§€ íƒ­ìœ¼ë¡œ ì´ë™
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[2].classList.add('active');
      document.getElementById('tab-message').classList.add('active');
      
      addLog('info', `ì±„íŒ…ë°© ì„ íƒë¨: ${roomId.substring(0, 8)}...`);
      loadMessages();
    }

    async function checkChatRoomExists() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      const user1 = document.getElementById('checkUser1').value;
      const user2 = document.getElementById('checkUser2').value;

      if (!user1 || !user2) {
        addLog('error', 'ë‘ ì‚¬ìš©ì IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ì±„íŒ…ë°© ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘...');
        
        const { data, error } = await supabase
          .from('chat_rooms')
          .select('*')
          .or(`and(user1_id.eq.${user1},user2_id.eq.${user2}),and(user1_id.eq.${user2},user2_id.eq.${user1})`)
          .maybeSingle();

        if (error) throw error;

        const result = document.getElementById('chatRoomCheckResult');
        
        if (data) {
          result.innerHTML = `
            <div class="status success">
              âœ… ì±„íŒ…ë°©ì´ ì¡´ì¬í•©ë‹ˆë‹¤!<br>
              Room ID: <code>${data.id}</code><br>
              ìƒíƒœ: ${data.is_active !== false ? 'í™œì„±' : 'ë¹„í™œì„±'}
            </div>
          `;
          addLog('success', `ì±„íŒ…ë°© ì¡´ì¬: ${data.id}`);
        } else {
          result.innerHTML = `
            <div class="status warning">
              âš ï¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>
              ë§¤ì¹­ì´ ìˆ˜ë½ë˜ì–´ì•¼ ì±„íŒ…ë°©ì´ ìƒì„±ë©ë‹ˆë‹¤.
            </div>
          `;
          addLog('warning', 'ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        addLog('error', `í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    async function createChatRoomManually() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      const user1 = document.getElementById('createUser1').value;
      const user2 = document.getElementById('createUser2').value;

      if (!user1 || !user2) {
        addLog('error', 'ë‘ ì‚¬ìš©ì IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ì±„íŒ…ë°© ìˆ˜ë™ ìƒì„± ì¤‘...');
        
        const { data, error } = await supabase
          .from('chat_rooms')
          .insert({
            user1_id: user1,
            user2_id: user2,
            is_active: true
          })
          .select()
          .single();

        if (error) throw error;

        document.getElementById('createRoomResult').innerHTML = `
          <div class="status success">
            âœ… ì±„íŒ…ë°© ìƒì„± ì„±ê³µ!<br>
            Room ID: <code>${data.id}</code>
          </div>
        `;
        
        addLog('success', `ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ: ${data.id}`);
      } catch (error) {
        document.getElementById('createRoomResult').innerHTML = `
          <div class="status error">âŒ ì‹¤íŒ¨: ${error.message}</div>
        `;
        addLog('error', `ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ==========================================
    // ë©”ì‹œì§€
    // ==========================================

    async function sendMessage() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      const roomId = document.getElementById('roomId').value;
      const senderId = document.getElementById('senderId').value;
      const recipientId = document.getElementById('recipientId').value;
      const content = document.getElementById('messageContent').value;

      if (!roomId || !senderId || !recipientId || !content) {
        addLog('error', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ë©”ì‹œì§€ ì „ì†¡ ì¤‘...');
        
        const { data, error } = await supabase
          .from('messages')
          .insert({
            room_id: roomId,
            sender_id: senderId,
            recipient_id: recipientId,
            content: content,
            is_read: false
          })
          .select()
          .single();

        if (error) throw error;

        document.getElementById('sendResult').innerHTML = `
          <div class="status success">
            âœ… ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!<br>
            ID: ${data.id}
          </div>
        `;
        
        document.getElementById('messageContent').value = '';
        addLog('success', `ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ! ID: ${data.id}`);
        loadMessages();
      } catch (error) {
        document.getElementById('sendResult').innerHTML = `
          <div class="status error">
            âŒ ì „ì†¡ ì‹¤íŒ¨: ${error.message}<br>
            <small>ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ê³  í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</small>
          </div>
        `;
        addLog('error', `ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    async function loadMessages() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      const roomId = document.getElementById('roomId').value;
      const senderId = document.getElementById('senderId').value;

      if (!roomId) {
        addLog('error', 'ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ ì¤‘...');
        
        const { data, error } = await supabase
          .from('messages')
          .select('*')
          .eq('room_id', roomId)
          .order('created_at', { ascending: true })
          .limit(50);

        if (error) throw error;

        const messageList = document.getElementById('messageList');
        
        if (data.length === 0) {
          messageList.innerHTML = '<p style="color: #999; text-align: center;">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</p>';
        } else {
          messageList.innerHTML = data.map(msg => `
            <div class="message-item ${msg.sender_id === senderId ? 'message-sent' : 'message-received'}">
              <strong>${msg.sender_id === senderId ? 'ë‚˜' : 'ìƒëŒ€ë°©'}:</strong> ${msg.content}
              <div style="font-size: 10px; opacity: 0.7; margin-top: 5px;">
                ${new Date(msg.created_at).toLocaleString('ko-KR')} 
                ${msg.is_read ? 'âœ“ ì½ìŒ' : ''}
              </div>
            </div>
          `).join('');
        }
        
        addLog('success', `${data.length}ê°œì˜ ë©”ì‹œì§€ë¥¼ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`);
      } catch (error) {
        addLog('error', `ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ==========================================
    // ì‹¤ì‹œê°„ êµ¬ë…
    // ==========================================

    async function subscribeToAll() {
      if (!supabase) {
        addLog('error', 'ë¨¼ì € Supabaseë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        addLog('info', 'ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘...');

        // ë©”ì‹œì§€ êµ¬ë…
        const msgSub = supabase
          .channel('debug-messages')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, (payload) => {
            addLog('realtime', `ğŸ“¨ Messages ${payload.eventType}: ID=${payload.new?.id || payload.old?.id}`);
          })
          .subscribe();

        // ì±„íŒ…ë°© êµ¬ë…
        const roomSub = supabase
          .channel('debug-rooms')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_rooms' }, (payload) => {
            addLog('realtime', `ğŸ  Chat Room ${payload.eventType}: ID=${payload.new?.id || payload.old?.id}`);
          })
          .subscribe();

        // ë§¤ì¹­ ìš”ì²­ êµ¬ë…
        const matchSub = supabase
          .channel('debug-matching')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'matching_requests' }, (payload) => {
            addLog('realtime', `ğŸ¯ Matching ${payload.eventType}: ${payload.new?.status || ''}`);
          })
          .subscribe();

        subscriptions = [msgSub, roomSub, matchSub];

        document.getElementById('realtimeStatus').className = 'realtime-indicator connected';
        document.getElementById('realtimeStatus').innerHTML = `
          <span class="pulse green"></span>
          <span>êµ¬ë… ì¤‘ âœ“</span>
        `;

        addLog('success', 'ì‹¤ì‹œê°„ êµ¬ë… í™œì„±í™”ë¨ (messages, chat_rooms, matching_requests)');
      } catch (error) {
        addLog('error', `êµ¬ë… ì‹¤íŒ¨: ${error.message}`);
      }
    }

    async function unsubscribeAll() {
      for (const sub of subscriptions) {
        await sub.unsubscribe();
      }
      subscriptions = [];

      document.getElementById('realtimeStatus').className = 'realtime-indicator disconnected';
      document.getElementById('realtimeStatus').innerHTML = `
        <span class="pulse red"></span>
        <span>êµ¬ë… í•´ì œë¨</span>
      `;

      addLog('success', 'ëª¨ë“  êµ¬ë…ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ==========================================
    // ì´ˆê¸°í™”
    // ==========================================

    window.addEventListener('load', () => {
      addLog('info', 'ğŸ“‹ í…ŒìŠ¤íŠ¸ ìˆœì„œ:');
      addLog('info', '1. Supabase ì—°ê²° â†’ ì‚¬ìš©ì ì¡°íšŒ');
      addLog('info', '2. ë§¤ì¹­ ìš”ì²­ ìƒì„± â†’ ìˆ˜ë½');
      addLog('info', '3. ì±„íŒ…ë°© ìë™ ìƒì„± í™•ì¸');
      addLog('info', '4. ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸');
    });
  </script>
</body>
</html>
